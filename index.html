<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning COT</title>
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon.svg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Planning">
  <meta name="theme-color" content="#1a3a5c">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <style>
    :root {
      --bg: #f1f5f9; --surface: #ffffff; --surface2: #e8eef4;
      --border: #e2e8f0; --border-light: #e5e7eb;
      --accent: #1a3a5c; --accent-light: #eef2f7; --accent-hover: #14304f;
      --text: #222222; --text-muted: #555555; --text-light: #888888;
      --green: #16a34a; --green-light: #dcfce7;
      --amber: #c0540a; --amber-light: #fef3c7;
      --red: #dc2626; --red-light: #fee2e2;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
      --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --radius-sm: 8px; --radius: 16px; --radius-lg: 24px;
      --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);

      --c-diferida: #64748b;
      --c-diferida-light: #f1f5f9;
      --c-qui-m: #1a3a5c;
      --c-qui-m-light: #e8eef5;
      --c-cons-m: #16a34a;
      --c-cons-m-light: #dcfce7;
      --c-saliente: #f59e0b;
      --c-saliente-light: #fef3c7;
      --c-cons-t: #0d9488;
      --c-cons-t-light: #ccfbf1;
      --c-qui-t: #3b82f6;
      --c-qui-t-light: #dbeafe;
      --c-guardia: #dc2626;
      --c-guardia-light: #fee2e2;
      --c-localizado: #7c3aed;
      --c-localizado-light: #f0ebff;
      --c-gestion: #ca8a04;
      --c-gestion-light: #fef9c3;
      --c-rucot: #e11d48;
      --c-rucot-light: #ffe4e6;
    }

    [data-theme="dark"] {
      --bg: #111827; --surface: #1f2937; --surface2: #283244;
      --border: #374151; --border-light: #4b5563;
      --text: #f1f5f9; --text-muted: #a8b8cc; --text-light: #64748b;
      --accent: #93c5fd; --accent-hover: #bae0ff;
      --accent-light: #1e3a5f;
      --green: #4ade80; --green-light: #14352a;
      --amber: #fbbf24; --amber-light: #3b2a10;
      --red: #f87171; --red-light: #3b1010;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2);
      --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.3);

      --c-qui-m: #38bdf8;
      --c-diferida-light: #334155;
      --c-qui-m-light: #1e3a5f;
      --c-cons-m-light: #14352a;
      --c-saliente-light: #3b2a10;
      --c-cons-t-light: #134e4a;
      --c-qui-t-light: #1e3a5f;
      --c-guardia-light: #3b1010;
      --c-localizado-light: #2e1065;
      --c-gestion-light: #3b2a10;
      --c-rucot-light: #4c1d2e;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', Arial, sans-serif; background: var(--bg);
      color: var(--text); min-height: 100vh; padding: 30px 20px;
      -webkit-tap-highlight-color: transparent;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .app-container { max-width: 1100px; margin: 0 auto; }

    .back-home {
      position: fixed; top: 10px; left: 10px;
      display: inline-flex; align-items: center; gap: 4px;
      font-family: 'SF Mono', 'Consolas', monospace; font-size: 11px; letter-spacing: 0.05em;
      color: var(--text-muted); text-decoration: none;
      padding: 6px 12px; border-radius: 999px;
      border: 1.5px solid var(--border); background: var(--surface);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      transition: border-color 0.2s, color 0.2s; z-index: 100;
    }
    .back-home:hover { border-color: var(--accent); color: var(--accent); }

    .app-header { text-align: center; margin-bottom: 28px; position: relative; }
    .app-header h1 {
      font-family: 'Lora', serif; color: var(--accent);
      font-size: clamp(1.3rem, 3vw, 1.7rem); font-weight: 700;
    }
    .app-header p { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

    .theme-toggle {
      position: absolute; top: 0.3rem; right: 0.3rem;
      background: var(--surface2); border: 1.5px solid var(--border);
      border-radius: 50%; width: 42px; height: 42px; font-size: 1.3rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); transition: border-color 0.2s, box-shadow 0.2s;
    }
    .theme-toggle:hover { border-color: var(--accent); box-shadow: var(--shadow-hover); }

    /* Upload zone */
    .upload-zone {
      background: var(--surface); border: 2px dashed var(--border);
      border-radius: var(--radius); padding: 16px 20px;
      display: flex; align-items: center; justify-content: center; gap: 12px; text-align: center;
      cursor: pointer; transition: border-color 0.3s, background 0.3s;
      max-width: 480px; margin: 0 auto 20px;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent); background: var(--accent-light);
      transform: translateY(-2px);
    }
    .upload-zone .icon { font-size: 1.5rem; flex-shrink: 0; }
    .upload-zone .title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .upload-zone .subtitle { font-size: 11px; color: var(--text-muted); }
    .upload-zone input[type="file"] { display: none; }

    /* Welcome hero image */
    .welcome-hero {
      text-align: center;
      margin: 0 auto 20px;
      max-width: 480px;
    }
    .welcome-hero-img {
      width: 100%; height: auto;
      display: block; margin: 0 auto;
      border-radius: 16px; opacity: 0.92;
    }
    [data-theme="dark"] .welcome-hero-img {
      opacity: 0.82; filter: brightness(0.85);
    }

    .upload-info {
      background: var(--accent-light); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 10px;
      max-width: 280px; margin: 0 auto 10px;
      font-size: 11px; display: flex; align-items: center; gap: 4px;
    }
    .upload-info .check { color: var(--green); font-weight: 700; font-size: 10px; }

    /* Surgeon selector */
    .controls {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      margin-bottom: 24px; justify-content: center;
    }
    .controls label {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .controls select {
      border: 1.5px solid var(--border); border-radius: 8px;
      padding: 10px 14px; font-size: 14px; font-family: 'Inter', Arial, sans-serif;
      color: var(--text); background: var(--surface);
      transition: border-color 0.2s, box-shadow 0.2s; min-width: 200px; max-width: 320px;
    }
    .export-group { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .export-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
    .export-btn {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 11px; font-weight: 600;
      border-radius: 6px; padding: 5px 12px; cursor: pointer;
      transition: all 0.2s; font-family: 'Inter', Arial, sans-serif;
    }
    .export-btn-ics, .export-btn-pdf {
      color: var(--text-muted); background: var(--surface);
      border: 1.5px solid var(--border);
    }
    .export-btn-ics:hover, .export-btn-pdf:hover,
    .export-btn-ics.active, .export-btn-pdf.active {
      border-color: var(--accent); color: var(--accent); background: var(--accent-light);
    }
    .export-menu {
      display: flex; gap: 4px; align-items: center; margin-top: 4px;
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: 8px; padding: 4px 8px; box-shadow: var(--shadow);
    }
    .export-menu-opt {
      font-size: 11px; font-weight: 600; color: var(--text);
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; padding: 4px 10px; cursor: pointer;
      transition: all 0.2s; font-family: 'Inter', Arial, sans-serif;
    }
    .export-menu-opt:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    .export-menu-close {
      font-size: 14px; color: var(--text-muted); background: none; border: none;
      cursor: pointer; padding: 2px 6px; line-height: 1;
    }
    .controls select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(26,58,92,0.10);
    }
    .custom-select { position: relative; min-width: 200px; max-width: 320px; }
    .custom-select-btn {
      width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 8px;
      border: 1.5px solid var(--border); border-radius: 8px;
      padding: 10px 14px; font-size: 14px; font-family: 'Inter', Arial, sans-serif;
      color: var(--text); background: var(--surface); cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s; text-align: left;
    }
    .custom-select-btn:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(26,58,92,0.10); }
    .custom-select-arrow { font-size: 10px; color: var(--text-muted); transition: transform 0.2s; }
    .custom-select.open .custom-select-arrow { transform: rotate(180deg); }
    .custom-select-dropdown {
      display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: var(--surface); border: 1.5px solid var(--border); border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12); z-index: 200;
      max-height: 240px; overflow-y: auto; overscroll-behavior: contain;
    }
    .custom-select.open .custom-select-dropdown { display: block; }
    .custom-select-option {
      padding: 8px 14px; font-size: 13px; cursor: pointer;
      transition: background 0.15s; border-bottom: 1px solid var(--border-light);
    }
    .custom-select-option:last-child { border-bottom: none; }
    .custom-select-option:hover, .custom-select-option:focus { background: var(--accent-light); }
    .custom-select-option.selected { color: var(--accent); font-weight: 600; background: var(--accent-light); }
    [data-theme="dark"] .custom-select-dropdown { box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
    @media (max-width: 600px) {
      .custom-select { min-width: unset; max-width: 260px; width: auto; }
      .custom-select-btn { padding: 6px 10px; font-size: 13px; }
      .custom-select-dropdown { max-height: 200px; }
      .custom-select-option { padding: 7px 12px; font-size: 12px; }
    }

    /* Results layout */
    .results { display: none; }
    .results.visible { display: flex; flex-direction: column; gap: 20px; }

    /* Calendar */
    .calendar-section {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px;
      display: flex; gap: 14px; align-items: flex-start;
    }
    .cal-main { flex: 1; min-width: 0; }
    .calendar-section h2 {
      font-family: 'Lora', serif; font-size: 1rem; color: var(--accent);
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
      justify-content: center;
    }
    .cal-nav {
      display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
      justify-content: center;
    }
    .cal-nav button {
      background: var(--surface2); border: 1.5px solid var(--border);
      border-radius: 6px; width: 28px; height: 28px; cursor: pointer;
      font-size: 12px; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--text);
    }
    .cal-nav button:hover { border-color: var(--accent); color: var(--accent); }
    .cal-nav .month-label {
      font-weight: 600; font-size: 13px; min-width: 120px; text-align: center;
    }
    .cal-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;
    }
    .cal-legend-side {
      width: 125px; flex-shrink: 0; display: flex; flex-direction: column;
      gap: 4px; padding-top: 58px;
    }
    .cal-legend-side .legend-item {
      font-size: 11px; display: flex; align-items: center; gap: 6px;
      color: var(--text-muted); white-space: nowrap;
    }
    .cal-legend-side .legend-dot {
      width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0;
    }
    .cal-header {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--text-light); text-align: center;
      padding: 4px 0;
    }
    .cal-cell {
      min-height: 56px; border-radius: var(--radius-sm); display: flex;
      flex-direction: column; align-items: stretch;
      font-size: 12px; font-weight: 500; position: relative;
      border: 1px solid transparent; transition: all 0.2s; cursor: default;
      overflow: hidden; padding: 3px; gap: 2px;
    }
    .cal-cell.empty { background: transparent; min-height: 42px; align-items: center; justify-content: center; }
    .cal-cell.has-activity {
      background: var(--surface2); border-color: var(--border-light);
    }
    .cal-cell.has-activity:hover { border-color: var(--accent); box-shadow: var(--shadow-sm); transform: translateY(-2px); }
    .cal-cell .day-num {
      font-weight: 700; font-size: 12px; line-height: 1;
      padding: 0 1px; color: var(--text); flex-shrink: 0;
      text-align: center; width: 100%;
    }
    .cal-cell.empty .day-num { color: var(--text-light); text-align: center; }

    /* Activity tags inside calendar cells */
    .cell-acts { display: flex; flex-direction: column; gap: 2px; flex: 1; justify-content: center; }
    .act-tag {
      display: block; padding: 2px 4px; border-radius: 4px;
      font-size: 9px; font-weight: 700; color: white;
      text-align: center; line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .act-tag.light-bg { color: #1a1a1a; }
    .cell-sep {
      height: 0; border-top: 1px dashed var(--border); margin: 1px 0;
    }
    .cal-cell.festive {
      background: linear-gradient(135deg, #fef9ef 0%, #fde8e0 100%);
      justify-content: center; align-items: center;
    }
    .cal-cell.festive .cell-acts {
      align-items: center; flex: 1; justify-content: center;
    }
    .cal-cell.festive .day-num { text-align: center; }
    .act-tag.act-centered { text-align: center; align-self: stretch; }
    .cal-cell.weekend { justify-content: center; align-items: center; }
    .cal-cell.weekend .cell-acts { align-items: center; flex: 1; justify-content: center; }
    .cal-cell.weekend .day-num { text-align: center; }
    [data-theme="dark"] .cal-cell.festive {
      background: linear-gradient(135deg, #2a2520 0%, #2d2025 100%);
    }
    [data-theme="dark"] .comparador-table tr.highlight { background: var(--accent-light); }
    [data-theme="dark"] .comparador-table tr.highlight .td-pct { color: #93c5fd; }
    [data-theme="dark"] .comparador-table tr:hover { background: var(--surface2); }

    /* Percentiles table */
    .perc-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .perc-table th { text-align: left; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 8px 8px; color: var(--text-muted); border-bottom: 2px solid var(--border); }
    .perc-table td { padding: 8px 8px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
    .perc-table td:first-child { font-weight: 600; white-space: nowrap; }
    .sparkbar-wrap { display: flex; align-items: center; gap: 6px; }
    .sparkbar { height: 8px; border-radius: 4px; background: var(--border-light); flex: 1; max-width: 80px; overflow: hidden; }
    .sparkbar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
    .sparkbar-fill.p-unit { background: var(--accent); }
    .sparkbar-fill.p-global { background: #7c3aed; }
    .sparkbar-pct { font-size: 10px; font-weight: 700; min-width: 28px; }
    [data-theme="dark"] .sparkbar { background: var(--border); }
    .perc-info { cursor: help; color: var(--text-light); font-size: 12px; position: relative; text-align: center; }
    [data-theme="dark"] .perc-info { color: #94a3b8; }
    .perc-info .perc-tip {
      display: none; position: absolute; right: -8px; bottom: calc(100% + 6px);
      background: #1a1a1a; color: #f1f5f9; padding: 10px 14px;
      border-radius: 10px; font-size: 11px; line-height: 1.5;
      width: 280px; z-index: 50; font-weight: 400;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25); text-align: left;
      pointer-events: none;
    }
    .perc-info:hover .perc-tip, .perc-info:focus .perc-tip { display: block; }

    /* Retribution section */
    .retrib-section {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 10px 14px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .retrib-section h2 { font-family: 'Lora', serif; font-size: 0.95rem; color: var(--accent); margin-bottom: 8px; text-align: center; }
    .retrib-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .retrib-table th { text-align: left; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 8px 8px; color: var(--text-muted); border-bottom: 2px solid var(--border); }
    .retrib-table th:not(:first-child) { text-align: center; }
    .retrib-table td { padding: 8px 8px; border-bottom: 1px solid var(--border-light); text-align: center; font-weight: 500; }
    .retrib-table td:first-child { text-align: left; font-weight: 600; }
    .retrib-table tfoot td { border-top: 2px solid var(--accent); font-weight: 700; color: var(--accent); }
    .retrib-footer { margin-top: 10px; text-align: center; }
    .retrib-calc-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 11px; font-weight: 600; color: var(--accent);
      text-decoration: none; padding: 6px 14px;
      border: 1.5px solid var(--accent); border-radius: 8px;
      transition: all 0.2s;
    }
    .retrib-calc-link:hover { background: var(--accent); color: white; }

    .companion-badge {
      display: block; font-size: 8px; font-weight: 600;
      color: var(--text-muted); background: var(--surface);
      border: 1px solid var(--border-light); border-radius: 4px;
      padding: 0 3px; margin-top: 0; line-height: 1.4;
      text-align: center; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }

    /* Bottom grid: summary + turns + retrib */
    .bottom-grid {
      display: grid; grid-template-columns: 1fr 1.4fr 1.2fr; gap: 14px;
    }

    /* Summary — compact table */
    .summary-section {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 10px 14px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .summary-section h2 {
      font-family: 'Lora', serif; font-size: 0.95rem; color: var(--accent);
      margin-bottom: 0; text-align: center;
    }
    .summary-toggle {
      display: flex; gap: 4px; margin-bottom: 0; align-items: center;
    }
    .summary-toggle button {
      padding: 3px 10px; border-radius: 6px;
      border: 1.5px solid var(--border); background: var(--surface);
      font-size: 11px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; color: var(--text-muted);
      font-family: 'Inter', Arial, sans-serif;
    }
    .summary-toggle button:hover { border-color: var(--accent); color: var(--accent); }
    .summary-toggle button.active {
      background: var(--accent); color: white; border-color: var(--accent);
    }
    .summary-range {
      font-size: 11px; color: var(--text-light); font-weight: 500;
    }
    .summary-table {
      display: grid; grid-template-columns: auto 1fr auto;
      gap: 2px 10px; align-items: center;
    }
    .st-row {
      display: contents; cursor: default;
    }
    .st-row:hover .st-label,
    .st-row:hover .st-count { color: var(--accent); }
    .st-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
    .st-label {
      font-size: 12px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.3px; color: var(--text-muted); transition: color 0.2s;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .st-count {
      font-size: 15px; font-weight: 700; text-align: right;
      transition: color 0.2s;
    }

    /* Turns section */
    .turns-section {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px;
    }
    .turns-section h2 {
      font-family: 'Lora', serif; font-size: 1rem; color: var(--accent);
      margin-bottom: 10px; text-align: center;
    }
    .turn-row {
      border-bottom: 1px solid var(--border-light);
      font-size: 12px; cursor: pointer; transition: background 0.2s;
    }
    .turn-row:last-child { border-bottom: none; }
    .turn-row:hover { background: var(--surface2); }
    .turn-row-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 5px 0;
    }
    .turn-week-label { color: var(--text-muted); }
    .turn-week-range { font-size: 10px; color: var(--text-light); margin-left: 4px; }
    .turn-count { font-weight: 700; color: var(--accent); display: inline-flex; align-items: center; gap: 4px; }
    .turn-count-zero { font-weight: 600; color: var(--text-light); }
    .turn-chevron { font-size: 8px; color: var(--text-light); transition: transform 0.2s; }
    .turn-row.open .turn-chevron { transform: rotate(180deg); }
    .turn-days {
      display: none; padding: 2px 0 6px 8px;
      font-size: 11px; color: var(--text-muted); line-height: 1.7;
    }
    .turn-days .turn-day-item { display: flex; align-items: center; gap: 6px; }
    .turn-days .turn-day-dot {
      width: 6px; height: 6px; border-radius: 2px; flex-shrink: 0;
    }
    .turn-row.open .turn-days { display: block; }
    .turn-total {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0 0; margin-top: 2px;
      border-top: 2px solid var(--accent);
      font-size: 13px; font-weight: 700; color: var(--accent);
    }
    .turn-total-label { display: flex; align-items: center; gap: 6px; }

    /* Toggle buttons (shared: jornada, comparativa, qx-unit) */
    .toggle-btns {
      display: inline-flex; gap: 2px; margin-bottom: 8px; align-items: center;
      background: var(--surface2); padding: 3px; border-radius: 10px;
      border: 1px solid var(--border-light);
    }
    .toggle-btns .toggle-label {
      font-size: 10px; font-weight: 600; color: var(--text-muted);
      margin-right: 4px; margin-left: 4px; text-transform: uppercase; letter-spacing: 0.3px;
    }
    .toggle-btns button {
      padding: 4px 12px; border-radius: 7px;
      border: none; background: transparent;
      font-size: 10px; font-weight: 600; cursor: pointer;
      color: var(--text-muted); font-family: 'Inter', Arial, sans-serif;
      transition: all 0.25s ease;
    }
    .toggle-btns button:hover { color: var(--text); }
    .toggle-btns button.active {
      background: var(--surface); color: var(--text);
      box-shadow: var(--shadow-sm);
    }

    /* Charts / Dashboard section */
    .charts-section {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden;
    }
    .charts-header {
      display: flex; align-items: center; justify-content: center;
      padding: 12px 16px; cursor: pointer; transition: background 0.2s;
      position: relative;
    }
    .charts-header:hover { background: var(--surface2); }
    .charts-header h2 {
      font-family: 'Lora', serif; font-size: 1rem; color: var(--accent); margin: 0;
    }
    .charts-collapse-btn {
      position: absolute; right: 16px;
      background: var(--surface2); border: 1.5px solid var(--border);
      border-radius: 6px; width: 28px; height: 28px; cursor: pointer;
      font-size: 11px; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s; color: var(--text-muted);
    }
    .charts-collapse-btn:hover { border-color: var(--accent); color: var(--accent); }
    .charts-collapse-btn.rotated { transform: rotate(180deg); }
    .charts-body {
      max-height: 0; overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                  padding 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0 16px;
    }
    .charts-body.expanded { max-height: 5500px; padding: 0 16px 16px; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .dash-wide { grid-column: 1 / -1; }
    .chart-card {
      background: var(--surface2); border: 1px solid var(--border-light);
      border-radius: var(--radius-sm); padding: 14px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .chart-card-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--text-muted);
    }
    .radar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .radar-col { text-align: center; }
    .radar-label {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--accent); margin-bottom: 4px;
    }

    /* D3 charts */
    .d3-chart-wrap { width: 100%; overflow: visible; }
    .d3-chart-wrap svg { display: block; width: 100%; height: auto; }
    .d3-tooltip {
      position: fixed; pointer-events: none;
      background: var(--surface); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 12px; font-size: 11px; font-family: 'Inter', sans-serif;
      box-shadow: var(--shadow); z-index: 9999;
      opacity: 0; transition: opacity 0.15s;
      max-width: 220px; line-height: 1.5;
    }
    .d3-tooltip.visible { opacity: 1; }
    .d3-tooltip strong { font-weight: 700; }

    /* Bubbles chart */
    .bubbles-container {
      display: flex; flex-wrap: wrap; align-items: center;
      justify-content: center; gap: 8px; padding: 12px 0 24px 0;
      min-height: 80px; overflow: visible;
    }
    .bubble {
      position: relative; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; color: white; font-weight: 700;
      font-family: 'Inter', sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      transition: transform 0.2s; cursor: pointer;
    }
    .bubble:hover { transform: scale(1.1); }
    .bubble-label {
      position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
      white-space: nowrap; font-size: 11px; font-weight: 600;
      color: var(--text); background: var(--surface); padding: 2px 7px;
      border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      pointer-events: none; z-index: 10;
    }

    /* Comparador table */
    .comparador-table-wrap { overflow-x: auto; margin-top: 6px; }
    .comparador-table {
      width: 100%; border-collapse: collapse; font-size: 11px;
    }
    .comparador-table th {
      text-align: center; font-size: 9px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.3px;
      padding: 8px 8px; color: var(--text-muted);
      white-space: nowrap;
    }
    .comparador-table th:first-child { text-align: left; }
    .comparador-table .th-group {
      font-size: 10px; font-weight: 700; color: white;
      padding: 4px 6px; border-radius: 4px 4px 0 0;
    }
    .comparador-table .th-group-qx { background: var(--accent); }
    .comparador-table .th-group-cons { background: var(--green); }
    .comparador-table .th-group-gest { background: var(--c-gestion, #ca8a04); }
    .comparador-table .th-sub {
      background: var(--surface2); border-bottom: 2px solid var(--border);
      font-size: 8px; padding: 3px 5px;
    }
    .comparador-table td {
      text-align: center; padding: 8px 8px;
      border-bottom: 1px solid var(--border-light);
      font-weight: 500; color: var(--text);
    }
    .comparador-table td:first-child {
      text-align: left; font-weight: 600; white-space: nowrap;
    }
    .comparador-table .td-total {
      font-weight: 700; border-left: 2px solid var(--border-light);
    }
    .comparador-table .td-pct {
      font-size: 10px; color: var(--text-muted); font-weight: 600;
      border-right: 2px solid var(--border-light);
    }
    .comparador-table tr.highlight td {
      background: var(--accent-light); font-weight: 700;
    }
    .comparador-table tr.highlight .td-pct { font-weight: 700; color: var(--accent); }
    .comparador-table tbody tr:hover td { background: var(--surface2); }

    /* Interactive Comparator */
    .icomp-toolbar {
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
    }
    .icomp-selector {
      display: flex; flex-direction: column; gap: 6px;
    }
    .icomp-hint {
      font-size: 10px; color: var(--text-light); font-style: italic;
    }
    .icomp-pill-grid {
      display: flex; flex-wrap: wrap; gap: 5px;
    }
    .icomp-surgeon-pill {
      padding: 5px 12px; border-radius: 999px; border: 1.5px solid var(--border);
      background: var(--surface); color: var(--text-muted);
      font-size: 11px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-family: 'Inter', Arial, sans-serif;
    }
    .icomp-surgeon-pill:hover { border-color: var(--accent); color: var(--accent); }
    .icomp-surgeon-pill.active { border-color: transparent; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .icomp-surgeon-pill.disabled { opacity: 0.35; pointer-events: none; }
    .icomp-metrics { display: flex; flex-wrap: wrap; gap: 6px; padding: 4px 0; }
    .icomp-metric-label {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border-light);
      font-size: 10px; font-weight: 600; color: var(--text-muted);
      cursor: pointer; transition: all 0.2s; user-select: none; background: var(--surface);
    }
    .icomp-metric-label:hover { border-color: var(--accent); }
    .icomp-metric-label input { display: none; }
    .icomp-metric-label.checked {
      background: var(--accent-light); border-color: var(--accent); color: var(--accent);
    }
    [data-theme="dark"] .icomp-metric-label.checked {
      background: rgba(96,165,250,0.15); color: var(--accent);
    }
    .icomp-delta-table {
      width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 8px;
    }
    .icomp-delta-table th {
      text-align: center; font-size: 9px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.3px;
      padding: 6px 8px; color: var(--text-muted); border-bottom: 2px solid var(--border);
    }
    .icomp-delta-table th:first-child { text-align: left; }
    .icomp-delta-table td {
      text-align: center; padding: 6px 8px;
      border-bottom: 1px solid var(--border-light); font-weight: 500; color: var(--text);
    }
    .icomp-delta-table td:first-child {
      text-align: left; font-weight: 600; font-size: 10px;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px;
    }
    .td-delta-pos { color: var(--green); font-weight: 700; }
    .td-delta-neg { color: var(--red); font-weight: 700; }
    .td-delta-zero { color: var(--text-light); }

    /* Ranking Gestión list */
    #card-ranking-gestion #ranking-gestion-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .rank-gestion-list { display: flex; flex-direction: column; gap: 6px; }
    .rank-gestion-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 12px; border-radius: 8px;
      background: var(--surface2); border: 1px solid var(--border-light);
      cursor: pointer; transition: all 0.2s; position: relative;
    }
    .rank-gestion-item:hover { border-color: var(--c-gestion); box-shadow: var(--shadow); }
    .rank-gestion-item.highlight { border-color: var(--c-gestion); background: var(--c-gestion-light); }
    .rank-gestion-pos {
      font-size: 11px; font-weight: 700; color: var(--text-light);
      min-width: 18px; text-align: center;
    }
    .rank-gestion-name { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
    .rank-gestion-count {
      font-size: 13px; font-weight: 700; color: var(--c-gestion);
      background: var(--c-gestion-light); padding: 2px 10px; border-radius: 6px;
    }
    .rank-gestion-days {
      display: none; width: 100%; padding: 6px 0 2px 28px;
      font-size: 11px; color: var(--text-muted); line-height: 1.6;
    }
    .rank-gestion-item.open .rank-gestion-days { display: block; }
    .rank-gestion-chevron {
      font-size: 10px; color: var(--text-light); transition: transform 0.2s;
    }
    .rank-gestion-item.open .rank-gestion-chevron { transform: rotate(180deg); }

    .app-footer { text-align: center; flex-shrink: 0; padding: 24px 0 8px; }
    .app-footer span { font-size: 0.7rem; color: var(--text-light); letter-spacing: 0.03em; }

    .toast-banner {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #7c3aed; color: white;
      padding: 12px 28px; border-radius: 10px;
      font-size: 0.95rem; font-weight: 600;
      font-family: 'Inter', Arial, sans-serif;
      box-shadow: 0 8px 32px rgba(124,58,237,0.30);
      z-index: 9999; opacity: 0;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
      pointer-events: none; display: flex; align-items: center; gap: 8px;
    }
    .toast-banner.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 768px) {
      .bottom-grid { grid-template-columns: 1fr; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .calendar-section { flex-direction: column; }
      .cal-legend-side {
        flex-direction: row; flex-wrap: wrap; width: auto;
        padding-top: 0; border-top: 1px solid var(--border-light);
        padding-top: 8px; margin-top: 8px;
      }
    }
    @media (max-width: 600px) {
      body { padding: 20px 12px; }
      .back-home { padding: 4px 8px; font-size: 10px; top: 6px; left: 6px; }
      .app-header p { padding: 0 44px; }
      .upload-zone { padding: 12px 14px; max-width: 100%; }
      .welcome-hero { max-width: 100%; margin: 0 auto 16px; }
      .welcome-hero-img { max-width: 100%; }
      .cal-grid { gap: 2px; }
      .cal-cell { min-height: 44px; padding: 2px; }
      .cal-cell .day-num { font-size: 10px; }
      .act-tag { font-size: 7px; padding: 1px 2px; }
      /* Tap-to-expand: show full companion names */
      .cal-cell.has-activity { cursor: pointer; transition: all 0.2s ease; position: relative; }
      .cal-cell.cell-expanded {
        z-index: 10; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        border-color: var(--accent); min-height: auto;
      }
      .cal-cell.cell-expanded .companion-badge {
        white-space: normal; overflow: visible; text-overflow: unset;
        font-size: 8px;
      }
      .cal-cell.cell-expanded .act-tag {
        white-space: normal; overflow: visible; text-overflow: unset;
      }
      .summary-card { padding: 8px 10px; }
      .summary-icon { width: 30px; height: 30px; font-size: 14px; }
      .summary-count { font-size: 17px; }
      .controls { flex-direction: column; align-items: center; gap: 4px; margin-bottom: 14px; }
      .controls select { min-width: unset; padding: 6px 10px; font-size: 13px; max-width: 260px; width: auto; }

      /* Charts mobile */
      .dashboard-grid { grid-template-columns: 1fr; }
      .charts-body { padding: 0 6px; }
      .charts-body.expanded { padding: 0 6px 12px; max-height: 9000px; }
      .chart-card { padding: 10px; overflow-x: auto; }

      /* Percentiles table: smaller font, scrollable */
      .perc-table { font-size: 10px; }
      .perc-table th { padding: 4px 4px; font-size: 8px; }
      .perc-table td { padding: 3px 4px; }
      .perc-table td:first-child { font-size: 10px; }
      .sparkbar { max-width: 50px; }
      .sparkbar-pct { font-size: 9px; min-width: 24px; }
      .perc-info .perc-tip { width: 220px; right: 0; left: auto; }
      #card-percentiles { overflow: visible; }

      /* Ranking Gestión list */
      .rank-gestion-item { padding: 8px 8px; gap: 6px; flex-wrap: wrap; }
      .rank-gestion-name { font-size: 12px; }
      .rank-gestion-count { font-size: 11px; padding: 2px 8px; }
      .rank-gestion-days { padding-left: 18px; font-size: 10px; }

      /* Comparador table */
      .comparador-table { font-size: 10px; }
      .comparador-table th, .comparador-table td { padding: 3px 4px; }

      /* Interactive comparator mobile */
      .icomp-toolbar { gap: 4px; }
      .icomp-surgeon-pill { font-size: 10px; padding: 4px 9px; }
      .icomp-metrics { gap: 4px; }
      .icomp-metric-label { font-size: 9px; padding: 3px 8px; }
      .icomp-delta-table { font-size: 10px; }
      .icomp-delta-table th, .icomp-delta-table td { padding: 3px 4px; }

      .radar-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app-container">
  <a class="back-home" href="https://jmacot.github.io/" title="Volver al inicio">&larr; Inicio</a>

  <div class="app-header">
    <h1>Analizador de Planning</h1>
    <p id="app-subtitle">Sube el archivo del planning mensual para ver el desglose por cirujano</p>
    <button class="theme-toggle" id="btn-theme" title="Cambiar tema"></button>
  </div>

  <!-- Upload -->
  <div class="upload-zone" id="upload-zone">
    <div class="icon">&#128203;</div>
    <div class="title">Insertar archivo</div>
    <div class="subtitle">.xlsx .xls .ods .csv</div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.ods,.csv">
  </div>

  <!-- Welcome hero image (below upload) -->
  <div class="welcome-hero" id="welcome-hero">
    <img src="portada.png" alt="Analizador de Planning" class="welcome-hero-img">
  </div>

  <div class="upload-info" id="upload-info" style="display:none">
    <span class="check">&#10003;</span>
    <span id="upload-summary"></span>
    <button onclick="resetApp()" style="margin-left:auto; background:none; border:1px solid var(--border); border-radius:4px; padding:2px 8px; font-size:10px; cursor:pointer; color:var(--text-muted);">Cambiar</button>
  </div>

  <!-- Controls -->
  <div class="controls" id="controls" style="display:none">
    <label>Cirujano</label>
    <div class="custom-select" id="custom-select">
      <button class="custom-select-btn" id="custom-select-btn" type="button">
        <span id="custom-select-label">Selecciona un cirujano...</span>
        <span class="custom-select-arrow">&#9662;</span>
      </button>
      <div class="custom-select-dropdown" id="custom-select-dropdown"></div>
    </div>
    <select id="surgeon-select" style="display:none">
      <option value="">Selecciona un cirujano...</option>
    </select>
    <div class="export-group" id="export-group" style="display:none">
      <span class="export-label">Exportar:</span>
      <button class="export-btn export-btn-ics" onclick="showExportMenu('ics')" title="Exportar a calendario (.ics)">&#128197; Calendario</button>
      <button class="export-btn export-btn-pdf" onclick="exportPDF()" title="Exportar a PDF">&#128196; PDF</button>
    </div>
    <div class="export-menu" id="export-menu" style="display:none">
      <button class="export-menu-opt" id="export-opt-month" onclick="doExport('month')"></button>
      <button class="export-menu-opt" id="export-opt-all" onclick="doExport('all')"></button>
      <button class="export-menu-close" onclick="closeExportMenu()">&times;</button>
    </div>
  </div>

  <!-- Results -->
  <div class="results" id="results">
    <!-- Calendar with side legend -->
    <div class="calendar-section">
      <div class="cal-main">
        <h2>&#128197; Calendario</h2>
        <div class="cal-nav">
          <button id="cal-prev" title="Mes anterior">&larr;</button>
          <span class="month-label" id="cal-month-label"></span>
          <button id="cal-next" title="Mes siguiente">&rarr;</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
      </div>
      <div class="cal-legend-side" id="legend"></div>
    </div>
    <!-- Bottom: summary + turns -->
    <div class="bottom-grid">
      <div class="summary-section" id="summary-section">
        <h2>&#128202; Resumen</h2>
        <div class="summary-toggle" id="summary-toggle">
          <button class="active" data-mode="month">Mes</button>
          <button data-mode="total">Total</button>
        </div>
        <div class="summary-range" id="summary-range"></div>
        <div class="summary-table" id="summary-cards"></div>
      </div>
      <div class="turns-section" id="turns-section">
        <h2>&#9201; Contaje Turnos</h2>
        <div class="toggle-btns" id="jornada-toggle">
          <span class="toggle-label">Jornada:</span>
          <button class="active" data-jornada="100">100%</button>
          <button data-jornada="80">80%</button>
          <button data-jornada="60">60%</button>
        </div>
        <div id="turns-content"></div>
      </div>
      <div class="retrib-section" id="retrib-section">
        <h2>&#128176; Retribuci&oacute;n Guardias</h2>
        <div class="toggle-btns" id="retrib-toggle">
          <button class="active" data-mode="contaje">Contaje</button>
          <button data-mode="bruto">Bruto</button>
          <button data-mode="neto">Neto</button>
        </div>
        <div id="retrib-content"></div>
        <div class="retrib-footer">
          <a id="retrib-calc-link" class="retrib-calc-link" href="https://jmacot.github.io/calculadora-guardias/" target="_blank">&#129518; Abrir Calculadora</a>
        </div>
      </div>
    </div>
    <!-- Dashboard Stats -->
    <div class="charts-section" id="charts-section">
      <div class="charts-header" id="charts-header">
        <h2>&#128200; Estad&iacute;sticas</h2>
        <button class="charts-collapse-btn" id="charts-collapse-btn">&#9660;</button>
      </div>
      <div class="charts-body" id="charts-body">
        <div class="dashboard-grid">
          <!-- Row 1: Individual -->
          <div class="chart-card dash-wide" id="card-bubbles">
            <div class="chart-card-title">Distribuci&oacute;n de Actividades</div>
            <div class="bubbles-container" id="bubbles-container"></div>
          </div>
          <!-- Percentiles -->
          <div class="chart-card dash-wide" id="card-percentiles">
            <div class="chart-card-title">Percentiles del Cirujano</div>
            <div id="percentiles-content"></div>
          </div>
          <div class="chart-card dash-wide" id="card-radar">
            <div class="chart-card-title">Perfil del Cirujano</div>
            <div class="radar-grid">
              <div class="radar-col">
                <div class="radar-label">Mes</div>
                <div id="chart-radar" class="d3-chart-wrap"></div>
              </div>
              <div class="radar-col">
                <div class="radar-label">Total</div>
                <div id="chart-radar-total" class="d3-chart-wrap"></div>
              </div>
            </div>
          </div>
          <!-- Row 2: Comparativa -->
          <div class="chart-card" id="card-comparativa">
            <div class="chart-card-title" id="comparativa-title">Comparativa Unidad</div>
            <div class="toggle-btns" id="comparativa-toggle">
              <button class="active" data-mode="turnos">Turnos</button>
              <button data-mode="guardias">Guardias</button>
            </div>
            <div id="chart-unit-comparison" class="d3-chart-wrap"></div>
          </div>
          <div class="chart-card" id="card-ranking-gestion">
            <div class="chart-card-title">Ranking Gesti&oacute;n</div>
            <div id="ranking-gestion-content"></div>
          </div>
          <!-- Comparador table -->
          <div class="chart-card dash-wide" id="card-comparador">
            <div class="chart-card-title">Comparador</div>
            <div class="toggle-btns" id="comparador-toggle">
              <button class="active" data-mode="cirujano">Por Cirujano</button>
              <button data-mode="unidad">Por Unidad</button>
            </div>
            <div class="comparador-table-wrap" id="comparador-content"></div>
          </div>
          <!-- Interactive Comparator -->
          <div class="chart-card dash-wide" id="card-interactive-comp">
            <div class="chart-card-title">Comparador Interactivo</div>
            <div class="icomp-toolbar">
              <div class="toggle-btns" id="icomp-mode-toggle">
                <button class="active" data-mode="cirujano">Cirujano</button>
                <button data-mode="unidad">Unidad</button>
              </div>
              <div class="toggle-btns" id="icomp-period-toggle">
                <button class="active" data-mode="month" id="icomp-period-month">Mes</button>
                <button data-mode="total" id="icomp-period-total">Total</button>
              </div>
              <div class="toggle-btns" id="icomp-viz-toggle">
                <button class="active" data-viz="slope">Slope</button>
                <button data-viz="bars">Barras</button>
              </div>
            </div>
            <div id="icomp-selector" class="icomp-selector"></div>
            <div id="icomp-metrics" class="icomp-metrics"></div>
            <div id="icomp-chart" class="d3-chart-wrap"></div>
            <div class="comparador-table-wrap" id="icomp-delta"></div>
          </div>
          <!-- Row 3: Global -->
          <div class="chart-card" id="card-qx-unidad">
            <div class="chart-card-title">Quir&oacute;fanos por Unidad</div>
            <div class="toggle-btns" id="qx-unit-toggle">
              <button class="active" data-mode="total">Total</button>
              <button data-mode="manana">Ma&ntilde;ana</button>
              <button data-mode="tarde">Tarde</button>
            </div>
            <div id="chart-qx-unit" class="d3-chart-wrap"></div>
          </div>
          <div class="chart-card" id="card-ranking-guardias">
            <div class="chart-card-title">Ranking Guardias</div>
            <div id="chart-ranking-guardias" class="d3-chart-wrap"></div>
          </div>
          <div class="chart-card" id="card-ranking-localizados">
            <div class="chart-card-title">Ranking Localizados</div>
            <div id="chart-ranking-localizados" class="d3-chart-wrap"></div>
          </div>
          <!-- Row 4: Global -->
          <div class="chart-card" id="card-ranking-turnos">
            <div class="chart-card-title">Ranking Actividad Total</div>
            <div id="chart-ranking-turnos" class="d3-chart-wrap"></div>
          </div>
          <!-- Row 5: Mañana/Tarde + Festivos -->
          <div class="chart-card" id="card-morning-afternoon">
            <div class="chart-card-title">Ma&ntilde;ana vs Tarde</div>
            <div id="chart-morning-afternoon" class="d3-chart-wrap"></div>
          </div>
          <div class="chart-card" id="card-festivos">
            <div class="chart-card-title">Festivos Trabajados</div>
            <div id="chart-festivos" class="d3-chart-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="app-footer"><span>COT &mdash; Planning Analyzer v2.0</span></div>
  <div id="toast" class="toast-banner"></div>
  <div id="d3-tooltip" class="d3-tooltip"></div>
</div>

<script>
// ─────────────────────────────────────────────
//  CONFIGURACION
// ─────────────────────────────────────────────
const SURGEONS = {
  1:'Fernando Baquero', 2:'Bea Grijalvo', 3:'Miguel Villa', 4:'Manuel Cintado',
  5:'Silvia Exposito', 6:'Antonio Ortiz', 7:'Marta del Rio', 8:'Alejandro Li\u00f1an',
  9:'Pepe Contreras', 10:'Jairo Hijazi', 11:'Manuel Centeno', 12:'Javier Martin',
  13:'Laura Hernandez', 14:'Libertad Caceres', 15:'Paco Barrionuevo',
  16:'Lorena Rial', 17:'Guille Estrada', 18:'Sara Gonzalez', 19:'Antonio Soler',
  20:'Eduardo Pereira', 21:'Alejandro Monge', 23:'Monica Sanchez',
  24:'Miriam Barcia', 25:'Veronica Delgado', 26:'Jose Maria Perez', 27:'Jaime Diez'
};

const SURGEON_UNITS = {
  1:['Rodilla','Cadera'], 2:['Rodilla'], 3:['Rodilla','Cadera'],
  4:['Rodilla'], 5:['Hombro'], 6:['Hombro'], 7:null,
  8:['Mano'], 9:['Pie'], 10:['Pie'], 11:['Mano'], 12:['Rodilla'],
  13:['Hombro'], 14:['Rodilla'], 15:['Pie'], 16:['Rodilla'],
  17:['Cadera'], 18:['Rodilla'], 19:['Pie'], 20:['Cadera'],
  21:['Hombro','Mano'], 23:['Mano'], 24:['Hombro'],
  25:['Trauma'], 26:['Trauma'], 27:['Pie']
};

function getSurgeonsByUnit(unit) {
  return Object.entries(SURGEON_UNITS)
    .filter(([_, u]) => u && u.includes(unit))
    .map(([id]) => Number(id));
}

const ACTIVITIES = {
  diferida:    { label: 'Diferida/Planta',   tag: 'Diferida/Planta', mobileTag: 'D/P', icon: '&#127973;', color: 'var(--c-diferida)',    bg: 'var(--c-diferida-light)',    period: 'morning' },
  qui_m:       { label: 'Quirofano M',       tag: 'Quirof M',        icon: '&#129657;', color: 'var(--c-qui-m)',       bg: 'var(--c-qui-m-light)',       period: 'morning' },
  cons_m:      { label: 'Consulta M',        tag: 'Cons M',          icon: '&#128196;', color: 'var(--c-cons-m)',      bg: 'var(--c-cons-m-light)',      period: 'morning' },
  saliente:    { label: 'Saliente',          tag: 'Saliente',        icon: '&#128164;', color: 'var(--c-saliente)',    bg: 'var(--c-saliente-light)',    period: 'allday',  lightTag: true },
  cons_t:      { label: 'Consulta T',        tag: 'Cons T',          icon: '&#128203;', color: 'var(--c-cons-t)',      bg: 'var(--c-cons-t-light)',      period: 'afternoon' },
  qui_t:       { label: 'Quirofano T',       tag: 'Quirof T',        icon: '&#128137;', color: 'var(--c-qui-t)',       bg: 'var(--c-qui-t-light)',       period: 'afternoon' },
  guardia:     { label: 'Guardia',           tag: 'Guardia',         icon: '&#128680;', color: 'var(--c-guardia)',     bg: 'var(--c-guardia-light)',     period: 'allday'  },
  localizado:  { label: 'Localizado',        tag: 'Localiz',         icon: '&#128222;', color: 'var(--c-localizado)',  bg: 'var(--c-localizado-light)',  period: 'allday'  },
  gestion:     { label: 'Gestion',           tag: 'Gestion',         icon: '&#128188;', color: 'var(--c-gestion)',     bg: 'var(--c-gestion-light)',     period: 'allday',  lightTag: true },
  diferida_t:  { label: 'Diferida', tag: 'Diferida', mobileTag: 'Dif', icon: '&#127973;', color: 'var(--c-diferida)',    bg: 'var(--c-diferida-light)',    period: 'afternoon' },
  rucot:       { label: 'RUCOT',             tag: 'RUCOT',           mobileTag: 'RUC',  icon: '&#128203;', color: 'var(--c-rucot)',       bg: 'var(--c-rucot-light)',       period: 'allday' }
};

// Row offsets from URG row
const ROW_OFFSETS = {
  diferida: 0,   // URG
  qui_m: 1,      // QUI (1st)
  cons_m: 2,     // CONS (1st)
  saliente: 3,   // SAL
  cons_t: 5,     // CONS (2nd)
  qui_t: 6,      // QUI (2nd)
  guardia: 7,    // GPF
  localizado: 8  // GLOC
};

const DAY_NAMES = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
const DAY_LABELS_SHORT = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
const MONTH_NAMES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

// ─────────────────────────────────────────────
//  FESTIVOS 2026 — Andalucia + Sevilla
// ─────────────────────────────────────────────
const HOLIDAYS_2026 = new Set([
  '2026-01-01','2026-01-06','2026-02-28',
  '2026-04-02','2026-04-03','2026-04-22',
  '2026-05-01','2026-06-04','2026-08-15',
  '2026-10-12','2026-11-02','2026-12-07',
  '2026-12-08','2026-12-25'
]);
function isHoliday(y, m, d) {
  return HOLIDAYS_2026.has(`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
}
function isNonWorkingDay(y, m, d) {
  const dow = new Date(y, m, d).getDay();
  return dow === 0 || dow === 6 || isHoliday(y, m, d) || isInferredHoliday(y, m, d);
}

// Detect inferred holidays: weekdays where the entire service only has guardia/saliente/localizado
const inferredHolidays = new Set();
function buildInferredHolidays() {
  inferredHolidays.clear();
  if (!parsedData) return;
  const workActivities = new Set(['qui_m', 'qui_t', 'cons_m', 'cons_t', 'diferida', 'diferida_t', 'gestion', 'rucot']);
  const dayActivities = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    for (const e of parsedData[id]) {
      const key = `${e.year}-${e.month}-${e.day}`;
      if (!dayActivities[key]) dayActivities[key] = { year: e.year, month: e.month, day: e.day, hasWork: false };
      if (workActivities.has(e.activity)) dayActivities[key].hasWork = true;
    }
  }
  for (const key of Object.keys(dayActivities)) {
    const d = dayActivities[key];
    const dow = new Date(d.year, d.month, d.day).getDay();
    if (dow >= 1 && dow <= 5 && !d.hasWork && !isHoliday(d.year, d.month, d.day)) {
      inferredHolidays.add(key);
    }
  }
}
function isInferredHoliday(y, m, d) {
  return inferredHolidays.has(`${y}-${m}-${d}`);
}

let parsedData = null;   // { surgeonId: [{ date, month, year, dayOfWeek, activity }] }
let allDates = [];        // [{ day, month, year, dayOfWeek }] sorted
let currentMonth = null;
let currentYear = null;
let availableMonths = [];
let summaryMode = 'month'; // 'month' or 'total'
let currentJornada = 100;  // 100, 80, or 60
let chartsExpanded = false;
let pendingExportType = null; // 'ics' or 'pdf'
let loadedFileName = '';

// ─────────────────────────────────────────────
//  TOAST
// ─────────────────────────────────────────────
function mostrarToast(msg) {
  const t = document.getElementById('toast');
  t.innerHTML = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ─────────────────────────────────────────────
//  THEME
// ─────────────────────────────────────────────
const btnTheme = document.getElementById('btn-theme');
function applyTheme(dark) {
  if (dark) {
    document.documentElement.setAttribute('data-theme', 'dark');
    btnTheme.textContent = '\u2600\uFE0F';
  } else {
    document.documentElement.removeAttribute('data-theme');
    btnTheme.textContent = '\uD83C\uDF19';
  }
  // Refresh charts with new theme colors
  if (chartsExpanded && parsedData) {
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid)) setTimeout(() => renderCharts(sid), 50);
  }
}
function getAutoTheme() {
  const hour = new Date().getHours();
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  return (hour >= 21 || hour < 7 || prefersDark) ? 'dark' : 'light';
}
function initTheme() {
  const saved = localStorage.getItem('planning-theme');
  const savedDate = localStorage.getItem('planning-theme-date');
  const today = new Date().toDateString();
  if (saved && savedDate === today) {
    applyTheme(saved === 'dark');
  } else {
    localStorage.removeItem('planning-theme');
    localStorage.removeItem('planning-theme-date');
    applyTheme(getAutoTheme() === 'dark');
  }
}
btnTheme.addEventListener('click', () => {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!isDark);
  localStorage.setItem('planning-theme', isDark ? 'light' : 'dark');
  localStorage.setItem('planning-theme-date', new Date().toDateString());
});
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  const saved = localStorage.getItem('planning-theme');
  const savedDate = localStorage.getItem('planning-theme-date');
  if (!saved || savedDate !== new Date().toDateString()) {
    applyTheme(getAutoTheme() === 'dark');
  }
});
initTheme();

// ─────────────────────────────────────────────
//  FILE UPLOAD
// ─────────────────────────────────────────────
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
});
fileInput.addEventListener('change', e => {
  if (e.target.files[0]) processFile(e.target.files[0]);
});

function resetApp() {
  parsedData = null;
  allDates = [];
  summaryMode = 'month';
  fileInput.value = '';
  document.getElementById('upload-zone').style.display = '';
  document.getElementById('welcome-hero').style.display = '';
  document.getElementById('app-subtitle').style.display = '';
  document.getElementById('upload-info').style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('results').classList.remove('visible');
}

function processFile(file) {
  loadedFileName = file.name;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellStyles: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      parseWorksheet(ws);
      mostrarToast('&#10003; Planning cargado correctamente');
    } catch(err) {
      console.error(err);
      mostrarToast('&#10060; Error al leer el archivo');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ─────────────────────────────────────────────
//  EXCEL PARSING (preserved exactly)
// ─────────────────────────────────────────────
function cellVal(ws, r, c) {
  const addr = XLSX.utils.encode_cell({ r: r - 1, c: c - 1 });
  const cell = ws[addr];
  return cell ? cell.v : null;
}

function findURGRows(ws) {
  const range = XLSX.utils.decode_range(ws['!ref']);
  const urgRows = [];
  for (let r = range.s.r; r <= range.e.r; r++) {
    const val = cellVal(ws, r + 1, 2); // col B
    if (val === 'URG') urgRows.push(r + 1); // 1-indexed
  }
  return urgRows;
}

function findDayColumnsInRow(ws, row) {
  const range = XLSX.utils.decode_range(ws['!ref']);
  const dayCols = {};
  for (let c = range.s.c; c <= range.e.c; c++) {
    const val = cellVal(ws, row, c + 1);
    if (val) {
      const normalized = String(val).trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      for (const dayName of DAY_NAMES) {
        const dayNorm = dayName.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        if (normalized === dayNorm || normalized.startsWith(dayNorm)) {
          dayCols[dayName] = c + 1; // 1-indexed
        }
      }
    }
  }
  return dayCols;
}

function findDayColumns(ws, urgRow) {
  // Search upward from URG row for the nearest row with day headers
  for (let offset = 2; offset <= 6; offset++) {
    const row = urgRow - offset;
    if (row < 1) continue;
    const dayCols = findDayColumnsInRow(ws, row);
    if (Object.keys(dayCols).length >= 5) return dayCols;
  }
  return null;
}

function getDayRanges(dayCols) {
  if (!dayCols) return {};
  const sortedDays = DAY_NAMES.filter(d => dayCols[d] !== undefined);
  const ranges = {};
  for (let i = 0; i < sortedDays.length; i++) {
    const day = sortedDays[i];
    const startCol = (day === 'LUNES') ? 3 : dayCols[day]; // LUNES extends to col C
    const endCol = (i < sortedDays.length - 1)
      ? dayCols[sortedDays[i + 1]] - 1
      : dayCols[day] + 7; // DOMINGO: extend 7 cols
    ranges[day] = { start: startCol, end: endCol, headerCol: dayCols[day] };
  }
  return ranges;
}

// Date offsets from day header column (verified from Excel structure)
const DATE_OFFSETS = {
  LUNES: 4, MARTES: 4, MIERCOLES: 4,
  JUEVES: 5, VIERNES: 5, SABADO: 4, DOMINGO: 4
};

function getDateForDay(ws, dateRow, dayRange, dayName) {
  // First try the expected date column position based on header offset
  const expectedCol = dayRange.headerCol + DATE_OFFSETS[dayName];
  const expectedVal = cellVal(ws, dateRow, expectedCol);
  if (expectedVal !== null && expectedVal !== undefined) {
    const num = parseInt(String(expectedVal).replace(/[^0-9]/g, ''), 10);
    if (!isNaN(num) && num >= 1 && num <= 31) return num;
  }
  // Fallback: try nearby columns around the expected position
  for (let delta = -1; delta <= 2; delta++) {
    if (delta === 0) continue; // already tried
    const c = expectedCol + delta;
    if (c < dayRange.start || c > dayRange.end) continue;
    const val = cellVal(ws, dateRow, c);
    if (val !== null && val !== undefined) {
      const num = parseInt(String(val).replace(/[^0-9]/g, ''), 10);
      if (!isNaN(num) && num >= 1 && num <= 31) return num;
    }
  }
  return null;
}

function getCellFgRGB(ws, r, c) {
  const addr = XLSX.utils.encode_cell({ r: r - 1, c: c - 1 });
  const cell = ws[addr];
  if (!cell || !cell.s) return null;
  const fg = cell.s.fgColor || (cell.s.fill && cell.s.fill.fgColor);
  if (!fg || !fg.rgb) return null;
  const rgb = fg.rgb.length > 6 ? fg.rgb.substring(fg.rgb.length - 6) : fg.rgb;
  return {
    r: parseInt(rgb.substring(0, 2), 16),
    g: parseInt(rgb.substring(2, 4), 16),
    b: parseInt(rgb.substring(4, 6), 16)
  };
}

function isCellOrange(ws, r, c) {
  const col = getCellFgRGB(ws, r, c);
  if (!col) return false;
  // Orange: R high (>180), G medium (80-210), B low (<80)
  return col.r > 180 && col.g > 80 && col.g < 210 && col.b < 80;
}

function isCellGreen(ws, r, c) {
  const col = getCellFgRGB(ws, r, c);
  if (!col) return false;
  // Green: G dominant (>150), G > R+30, B < 150
  return col.g > 150 && col.g > col.r + 30 && col.b < 150;
}

function extractSurgeonIds(ws, row, dayRange) {
  const ids = [];
  for (let c = dayRange.start; c <= dayRange.end; c++) {
    const val = cellVal(ws, row, c);
    if (val === null || val === undefined) continue;
    const str = String(val).trim();
    if (str === '' || str.toUpperCase() === 'R') continue;
    const isGestion = str.includes('*') || isCellOrange(ws, row, c);
    const num = parseInt(str.replace(/[^0-9]/g, ''), 10);
    if (!isNaN(num) && num >= 1 && num <= 30) {
      ids.push({ id: num, gestion: isGestion, col: c });
    }
  }
  return ids;
}

// Adjust day ranges for quirófano rows: ensures even surgeon count per day
// Quirófano always has surgeon pairs (main+assistant), so count must be even.
// Scans right-to-left: if a day has odd count, extends its start by 1 column
// and shrinks the previous day accordingly.
function adjustQuiRanges(ws, actRow, dayRanges) {
  const dayOrder = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
  const adjusted = {};
  for (const day of dayOrder) {
    if (!dayRanges[day]) continue;
    adjusted[day] = { start: dayRanges[day].start, end: dayRanges[day].end, headerCol: dayRanges[day].headerCol };
  }
  // Process right-to-left: extend left if odd count
  for (let i = dayOrder.length - 1; i >= 0; i--) {
    const day = dayOrder[i];
    if (!adjusted[day]) continue;
    const range = adjusted[day];
    let count = 0;
    for (let c = range.start; c <= range.end; c++) {
      const val = cellVal(ws, actRow, c);
      if (val !== null && val !== undefined) {
        const str = String(val).trim();
        if (str !== '' && str.toUpperCase() !== 'R') count++;
      }
    }
    if (count % 2 === 1 && count > 0 && range.start > 3) {
      const extraCol = range.start - 1;
      const val = cellVal(ws, actRow, extraCol);
      if (val !== null && val !== undefined) {
        const str = String(val).trim();
        if (str !== '' && str.toUpperCase() !== 'R') {
          adjusted[day].start = extraCol;
          // Shrink previous day to avoid double-counting
          const prevDay = dayOrder[i - 1];
          if (prevDay && adjusted[prevDay]) {
            adjusted[prevDay].end = extraCol - 1;
          }
        }
      }
    }
  }
  return adjusted;
}

// General gap-based range adjustment for any row type.
// If a day's range contains a gap of 2+ empty cells followed by data,
// that data likely belongs to the next day (boundary spillover).
function adjustDayRangesForRow(ws, row, dayRanges) {
  const dayOrder = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
  const adjusted = {};
  for (const day of dayOrder) {
    if (!dayRanges[day]) continue;
    adjusted[day] = { start: dayRanges[day].start, end: dayRanges[day].end, headerCol: dayRanges[day].headerCol };
  }

  for (let i = 0; i < dayOrder.length - 1; i++) {
    const currDay = dayOrder[i];
    const nextDay = dayOrder[i + 1];
    if (!adjusted[currDay] || !adjusted[nextDay]) continue;

    const range = adjusted[currDay];
    let gapCount = 0;
    let foundAnyData = false;

    for (let c = range.start; c <= range.end; c++) {
      const val = cellVal(ws, row, c);
      const str = (val !== null && val !== undefined) ? String(val).trim() : '';
      const hasVal = str !== '' && str.toUpperCase() !== 'R';

      if (hasVal) {
        if (foundAnyData && gapCount >= 2) {
          // Data after a 2+ cell gap: belongs to next day
          adjusted[currDay].end = c - 1;
          adjusted[nextDay].start = c;
          break;
        }
        foundAnyData = true;
        gapCount = 0;
      } else {
        if (foundAnyData) gapCount++;
      }
    }
  }

  return adjusted;
}

function parseWorksheet(ws) {
  const urgRows = findURGRows(ws);
  parsedData = {};
  allDates = [];
  const dateSet = new Set();

  // Determine month/year from date sequences
  // Collect all dates first to figure out months
  const rawWeeks = [];

  let lastDayCols = null;
  for (const urgRow of urgRows) {
    const dateRow = urgRow - 1;
    let dayCols = findDayColumns(ws, urgRow);
    if (!dayCols && lastDayCols) {
      dayCols = lastDayCols; // Reuse previous block's day columns
    }
    if (dayCols) lastDayCols = dayCols;
    const dayRanges = getDayRanges(dayCols);

    const weekDates = [];
    for (const dayName of DAY_NAMES) {
      if (!dayRanges[dayName]) continue;
      const date = getDateForDay(ws, dateRow, dayRanges[dayName], dayName);
      if (date !== null) {
        weekDates.push({ dayName, date, dayRange: dayRanges[dayName], urgRow });
      }
    }
    rawWeeks.push(weekDates);
  }

  // ── Determine starting month/year from date pattern ──
  // Strategy: find month boundaries, detect February (28 days) as anchor
  const flatDates = rawWeeks.flat().map(d => d.date);

  // Find month boundaries (date drops from high to low)
  const boundaries = []; // indices where new month starts
  for (let i = 1; i < flatDates.length; i++) {
    if (flatDates[i] < flatDates[i - 1] - 5) {
      boundaries.push({ index: i, prevMax: flatDates[i - 1] });
    }
  }

  // Month segments: [start..boundary0], [boundary0..boundary1], ...
  const segments = [];
  let segStart = 0;
  for (const b of boundaries) {
    const segDates = flatDates.slice(segStart, b.index);
    segments.push({ maxDate: Math.max(...segDates), count: segDates.length });
    segStart = b.index;
  }
  if (segStart < flatDates.length) {
    const segDates = flatDates.slice(segStart);
    segments.push({ maxDate: Math.max(...segDates), count: segDates.length });
  }

  // Find February: the segment with maxDate 28 (non-leap) or 29 (leap)
  let febSegIndex = -1;
  for (let i = 0; i < segments.length; i++) {
    if (segments[i].maxDate === 28 || segments[i].maxDate === 29) {
      // Verify it's a full month (has enough dates, not just a partial segment)
      if (segments[i].count >= 20) { febSegIndex = i; break; }
    }
  }

  // Determine starting month/year by counting back from February
  const now = new Date();
  let startMonth, startYear;
  if (febSegIndex >= 0) {
    // February is at segment index febSegIndex
    const febMonth = 1; // February = month index 1
    const febYear = now.getFullYear();
    startMonth = febMonth - febSegIndex;
    startYear = febYear;
    while (startMonth < 0) { startMonth += 12; startYear--; }
  } else {
    // Fallback: guess from current date
    startMonth = now.getMonth() - 1;
    startYear = now.getFullYear();
    if (startMonth < 0) { startMonth = 11; startYear--; }
    if (flatDates[0] > 15) {
      startMonth--;
      if (startMonth < 0) { startMonth = 11; startYear--; }
    }
  }

  let trackMonth = startMonth;
  let trackYear = startYear;
  let prevDate = 0;

  function maxDaysInMonth(m, y) {
    return new Date(y, m + 1, 0).getDate();
  }

  for (const weekDates of rawWeeks) {
    // Build weekDayRanges map for range adjustment
    const weekDayRanges = {};
    for (const wd of weekDates) {
      weekDayRanges[wd.dayName] = wd.dayRange;
    }

    // Pre-compute adjusted ranges for ALL activity rows in this week
    const weekUrgRow = weekDates[0].urgRow;
    const adjustedPerActivity = {};
    for (const [actKey, offset] of Object.entries(ROW_OFFSETS)) {
      const actRow = weekUrgRow + offset;
      if (actKey === 'qui_m' || actKey === 'qui_t') {
        // Quirófano: use even-count principle (pairs must be even)
        adjustedPerActivity[actKey] = adjustQuiRanges(ws, actRow, weekDayRanges);
      } else {
        // All other rows: use gap detection (2+ empty cells = day boundary)
        adjustedPerActivity[actKey] = adjustDayRangesForRow(ws, actRow, weekDayRanges);
      }
    }

    for (const wd of weekDates) {
      // Detect month rollover (big drop in date number)
      if (wd.date < prevDate - 5) {
        trackMonth++;
        if (trackMonth > 11) { trackMonth = 0; trackYear++; }
      }
      // Validate: if day exceeds the max for this month, bump to next month
      if (wd.date > maxDaysInMonth(trackMonth, trackYear)) {
        trackMonth++;
        if (trackMonth > 11) { trackMonth = 0; trackYear++; }
      }
      prevDate = wd.date;

      const dayOfWeek = DAY_NAMES.indexOf(wd.dayName);
      const dateKey = `${trackYear}-${trackMonth}-${wd.date}`;

      if (!dateSet.has(dateKey)) {
        dateSet.add(dateKey);
        allDates.push({ day: wd.date, month: trackMonth, year: trackYear, dayOfWeek });
      }

      // Parse activities for this day
      for (const [actKey, offset] of Object.entries(ROW_OFFSETS)) {
        const actRow = wd.urgRow + offset;
        const isQuirofano = (actKey === 'qui_m' || actKey === 'qui_t');
        const isCons = (actKey === 'cons_m' || actKey === 'cons_t');

        // Use pre-computed adjusted range for this activity
        let range = wd.dayRange;
        if (adjustedPerActivity[actKey] && adjustedPerActivity[actKey][wd.dayName]) {
          range = adjustedPerActivity[actKey][wd.dayName];
        }

        const surgeonIds = extractSurgeonIds(ws, actRow, range);

        for (let si = 0; si < surgeonIds.length; si++) {
          const { id, gestion, col } = surgeonIds[si];
          if (!parsedData[id]) parsedData[id] = [];

          // Determine activity: gestion > green overrides > default
          let activity;
          if (gestion) {
            activity = 'gestion';
          } else if (actKey === 'qui_t' && isCellGreen(ws, actRow, col)) {
            activity = 'diferida_t';
          } else if (isCons && isCellGreen(ws, actRow, col)) {
            activity = 'rucot';
          } else {
            activity = actKey;
          }

          const entry = {
            day: wd.date, month: trackMonth, year: trackYear,
            dayOfWeek, activity
          };

          // Quirofano pairing: consecutive columns = pairs
          // Excel layout: [main1, assist1, main2, assist2, ...]
          if (isQuirofano && (activity === 'qui_m' || activity === 'qui_t')) {
            const pairIdx = (si % 2 === 0) ? si + 1 : si - 1;
            if (pairIdx >= 0 && pairIdx < surgeonIds.length) {
              entry.companions = [surgeonIds[pairIdx].id];
            } else {
              entry.companions = [];
            }
          }

          parsedData[id].push(entry);
        }
      }
    }
  }

  allDates.sort((a, b) => {
    if (a.year !== b.year) return a.year - b.year;
    if (a.month !== b.month) return a.month - b.month;
    return a.day - b.day;
  });

  // Determine available months
  const monthSet = new Set();
  allDates.forEach(d => monthSet.add(`${d.year}-${d.month}`));
  availableMonths = Array.from(monthSet).sort().map(s => {
    const [y, m] = s.split('-').map(Number);
    return { year: y, month: m };
  });

  // Find the month with most dates
  const monthCounts = {};
  allDates.forEach(d => {
    const key = `${d.year}-${d.month}`;
    monthCounts[key] = (monthCounts[key] || 0) + 1;
  });
  const mainMonthKey = Object.entries(monthCounts).sort((a,b) => b[1] - a[1])[0]?.[0];
  if (mainMonthKey) {
    const [y, m] = mainMonthKey.split('-').map(Number);
    currentMonth = m;
    currentYear = y;
  } else if (availableMonths.length > 0) {
    currentMonth = availableMonths[0].month;
    currentYear = availableMonths[0].year;
  }

  // Build inferred holidays from parsed data
  buildInferredHolidays();

  // Populate UI
  showUploadSuccess();
  populateSurgeonSelect();
}

function showUploadSuccess() {
  document.getElementById('upload-zone').style.display = 'none';
  document.getElementById('welcome-hero').style.display = 'none';
  document.getElementById('app-subtitle').style.display = 'none';
  document.getElementById('upload-info').style.display = 'flex';
  document.getElementById('upload-summary').textContent = loadedFileName;
  document.getElementById('controls').style.display = 'flex';
}

function populateSurgeonSelect() {
  const select = document.getElementById('surgeon-select');
  select.innerHTML = '<option value="">Selecciona un cirujano...</option>';
  const ids = Object.keys(parsedData).map(Number).sort((a, b) => a - b);
  for (const id of ids) {
    const name = SURGEONS[id] || `Cirujano ${id}`;
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = `T${id} \u2014 ${name}`;
    select.appendChild(opt);
  }
  populateCustomSelect();
}

// ─────────────────────────────────────────────
//  CUSTOM SELECT DROPDOWN
// ─────────────────────────────────────────────
function populateCustomSelect() {
  const select = document.getElementById('surgeon-select');
  const dropdown = document.getElementById('custom-select-dropdown');
  const label = document.getElementById('custom-select-label');
  dropdown.innerHTML = '';
  for (const opt of select.options) {
    const div = document.createElement('div');
    div.className = 'custom-select-option';
    div.dataset.value = opt.value;
    div.textContent = opt.textContent;
    if (opt.value === select.value) div.classList.add('selected');
    div.addEventListener('click', function() {
      select.value = this.dataset.value;
      select.dispatchEvent(new Event('change', {bubbles: true}));
      label.textContent = this.textContent;
      dropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('custom-select').classList.remove('open');
    });
    dropdown.appendChild(div);
  }
  label.textContent = select.options[select.selectedIndex]?.textContent || 'Selecciona un cirujano...';
}

(function() {
  const wrap = document.getElementById('custom-select');
  const btn = document.getElementById('custom-select-btn');
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    wrap.classList.toggle('open');
  });
  document.addEventListener('click', function(e) {
    if (!wrap.contains(e.target)) wrap.classList.remove('open');
  });
})()

// ─────────────────────────────────────────────
//  SURGEON SELECT & RENDER
// ─────────────────────────────────────────────
document.getElementById('surgeon-select').addEventListener('change', function() {
  const id = parseInt(this.value, 10);
  const exportGroup = document.getElementById('export-group');
  closeExportMenu();
  if (isNaN(id)) {
    document.getElementById('results').classList.remove('visible');
    exportGroup.style.display = 'none';
    return;
  }
  exportGroup.style.display = 'flex';
  renderResults(id);
});

document.getElementById('cal-prev').addEventListener('click', () => navigateMonth(-1));
document.getElementById('cal-next').addEventListener('click', () => navigateMonth(1));

function navigateMonth(dir) {
  const idx = availableMonths.findIndex(m => m.month === currentMonth && m.year === currentYear);
  const newIdx = idx + dir;
  if (newIdx >= 0 && newIdx < availableMonths.length) {
    currentMonth = availableMonths[newIdx].month;
    currentYear = availableMonths[newIdx].year;
    const surgeonId = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(surgeonId)) renderResults(surgeonId);
  }
}

function renderResults(surgeonId) {
  document.getElementById('results').classList.add('visible');
  renderCalendar(surgeonId);
  renderSummary(surgeonId);
  renderTurns(surgeonId);
  renderRetribution(surgeonId);
  renderLegend();
  if (chartsExpanded) renderCharts(surgeonId);
}

// ─────────────────────────────────────────────
//  SUMMARY TOGGLE
// ─────────────────────────────────────────────
document.querySelectorAll('#summary-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#summary-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    summaryMode = this.dataset.mode;
    const surgeonId = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(surgeonId)) renderSummary(surgeonId);
  });
});

// ─────────────────────────────────────────────
//  CALENDAR RENDER
// ─────────────────────────────────────────────
function renderCalendar(surgeonId) {
  const grid = document.getElementById('cal-grid');
  const label = document.getElementById('cal-month-label');
  label.textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;

  const entries = (parsedData[surgeonId] || []).filter(
    e => e.month === currentMonth && e.year === currentYear
  );

  const isMobile = window.innerWidth <= 600;

  // Group by day — store objects with activity + companions
  const dayMap = {};
  entries.forEach(e => {
    if (!dayMap[e.day]) dayMap[e.day] = [];
    const existing = dayMap[e.day].find(x => x.activity === e.activity);
    if (!existing) {
      dayMap[e.day].push({ activity: e.activity, companions: e.companions ? [...e.companions] : [] });
    } else if (e.companions) {
      e.companions.forEach(c => {
        if (!existing.companions.includes(c)) existing.companions.push(c);
      });
    }
  });

  // Guardia + diferida: hide diferida, keep only guardia (day acts as festive)
  for (const day in dayMap) {
    const items = dayMap[day];
    const hasGuardia = items.some(x => x.activity === 'guardia');
    const hasDiferida = items.some(x => x.activity === 'diferida');
    if (hasGuardia && hasDiferida) {
      dayMap[day] = items.filter(x => x.activity !== 'diferida');
    }
  }

  // Build calendar grid
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const startOffset = (firstDay === 0) ? 6 : firstDay - 1;
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  let html = '';
  // Headers
  for (const dl of DAY_LABELS_SHORT) {
    html += `<div class="cal-header">${dl}</div>`;
  }

  // Empty cells before start
  for (let i = 0; i < startOffset; i++) {
    html += '<div class="cal-cell empty"></div>';
  }

  // Day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const dayItems = dayMap[d] || [];
    if (dayItems.length === 0) {
      html += `<div class="cal-cell empty"><span class="day-num">${d}</span></div>`;
      continue;
    }

    const actKeys = dayItems.map(x => x.activity);

    // Group activities by period
    const morningItems = dayItems.filter(x => ACTIVITIES[x.activity]?.period === 'morning');
    const afternoonItems = dayItems.filter(x => ACTIVITIES[x.activity]?.period === 'afternoon');
    const alldayItems = dayItems.filter(x => ACTIVITIES[x.activity]?.period === 'allday');

    const tooltip = actKeys.map(a => ACTIVITIES[a]?.label || a).join(' + ');

    // Festive detection: official holidays + inferred holidays get gradient, weekends just center
    const jsDay = new Date(currentYear, currentMonth, d).getDay();
    const isWeekend = (jsDay === 0 || jsDay === 6);
    const isOfficialHoliday = isHoliday(currentYear, currentMonth, d);
    const isInferred = isInferredHoliday(currentYear, currentMonth, d);
    const festiveClass = (isOfficialHoliday || isInferred) ? ' festive' : (isWeekend ? ' weekend' : '');

    html += `<div class="cal-cell has-activity${festiveClass}" title="${tooltip}">`;
    html += `<span class="day-num">${d}</span>`;
    html += '<div class="cell-acts">';

    // Helper to render a tag + optional companion badge
    function renderTag(item) {
      const info = ACTIVITIES[item.activity];
      if (!info) return '';
      const lightClass = info.lightTag ? ' light-bg' : '';
      const centeredClass = (item.activity === 'guardia' || item.activity === 'saliente') ? ' act-centered' : '';
      const tagText = (info.mobileTag && isMobile) ? info.mobileTag : info.tag;
      let tagHtml = `<span class="act-tag${lightClass}${centeredClass}" style="background:${info.color}">${tagText}</span>`;
      // Companion badge for quirofano
      if ((item.activity === 'qui_m' || item.activity === 'qui_t') && item.companions.length > 0) {
        const names = item.companions.map(cid => {
          const full = SURGEONS[cid];
          return full ? full.split(' ').pop() : `T${cid}`;
        });
        tagHtml += `<span class="companion-badge">\u21B3 ${names.join(', ')}</span>`;
      }
      return tagHtml;
    }

    // Allday tags
    for (const item of alldayItems) { html += renderTag(item); }
    // Morning tags
    for (const item of morningItems) { html += renderTag(item); }

    // Separator if both morning/allday AND afternoon
    if ((morningItems.length > 0 || alldayItems.length > 0) && afternoonItems.length > 0) {
      html += '<span class="cell-sep"></span>';
    }

    // Afternoon tags
    for (const item of afternoonItems) { html += renderTag(item); }

    html += '</div></div>';
  }

  // Fill remaining cells
  const totalCells = startOffset + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let i = 0; i < remaining; i++) {
    html += '<div class="cal-cell empty"></div>';
  }

  grid.innerHTML = html;

  // Mobile: tap to expand day cells for full companion names
  if (isMobile) {
    grid.querySelectorAll('.cal-cell.has-activity').forEach(cell => {
      cell.addEventListener('click', () => {
        const wasExpanded = cell.classList.contains('cell-expanded');
        grid.querySelectorAll('.cell-expanded').forEach(c => c.classList.remove('cell-expanded'));
        if (!wasExpanded) cell.classList.add('cell-expanded');
      });
    });
  }
}

// ─────────────────────────────────────────────
//  SUMMARY RENDER
// ─────────────────────────────────────────────
function renderSummary(surgeonId) {
  const container = document.getElementById('summary-cards');
  const rangeEl = document.getElementById('summary-range');
  const allEntries = parsedData[surgeonId] || [];
  const entries = (summaryMode === 'month')
    ? allEntries.filter(e => e.month === currentMonth && e.year === currentYear)
    : allEntries;

  // Range subtitle
  if (summaryMode === 'month') {
    rangeEl.textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
  } else {
    if (availableMonths.length > 0) {
      const first = availableMonths[0];
      const last = availableMonths[availableMonths.length - 1];
      if (first.month === last.month && first.year === last.year) {
        rangeEl.textContent = `${MONTH_NAMES[first.month]} ${first.year}`;
      } else {
        const fYear = first.year === last.year ? '' : ` ${first.year}`;
        rangeEl.textContent = `${MONTH_NAMES[first.month]}${fYear} — ${MONTH_NAMES[last.month]} ${last.year}`;
      }
    } else {
      rangeEl.textContent = '';
    }
  }

  const grouped = {};
  for (const e of entries) {
    if (!grouped[e.activity]) grouped[e.activity] = [];
    grouped[e.activity].push(e);
  }

  const order = ['guardia', 'saliente', 'localizado', 'qui_m', 'diferida', 'qui_t', 'diferida_t', 'cons_m', 'cons_t', 'rucot', 'gestion'];

  let html = '';
  for (const actKey of order) {
    const actEntries = grouped[actKey];
    if (!actEntries || actEntries.length === 0) continue;
    const actInfo = ACTIVITIES[actKey];
    if (!actInfo) continue;

    // Build tooltip with days
    let tipText = '';
    if (summaryMode === 'month') {
      const days = [...new Set(actEntries.map(e => e.day))].sort((a, b) => a - b);
      tipText = `D\u00edas: ${days.join(', ')}`;
    } else {
      const byMonth = {};
      actEntries.forEach(e => {
        const mKey = MONTH_NAMES[e.month];
        if (!byMonth[mKey]) byMonth[mKey] = [];
        byMonth[mKey].push(e.day);
      });
      tipText = Object.entries(byMonth).map(([m, d]) => `${m}: ${[...new Set(d)].sort((a,b)=>a-b).join(', ')}`).join(' | ');
    }

    html += `<div class="st-row" title="${tipText}">
      <span class="st-dot" style="background:${actInfo.color}"></span>
      <span class="st-label" style="color:${actInfo.color}">${actInfo.label}</span>
      <span class="st-count" style="color:${actInfo.color}">${actEntries.length}</span>
    </div>`;
  }

  if (!html) {
    html = '<div style="grid-column:1/-1;text-align:center;padding:16px;color:var(--text-light);font-size:12px;">Sin actividades</div>';
  }

  container.innerHTML = html;
}

// ─────────────────────────────────────────────
//  TURNS RENDER
// ─────────────────────────────────────────────
function renderTurns(surgeonId) {
  const container = document.getElementById('turns-content');
  const entries = (parsedData[surgeonId] || []).filter(
    e => e.month === currentMonth && e.year === currentYear
  );

  // Calculate weeks of the month (Mon-Sun)
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const startOffset = (firstDay === 0) ? 6 : firstDay - 1;
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  const weeks = [];
  let firstWeekEnd = 7 - startOffset;
  if (firstWeekEnd > daysInMonth) firstWeekEnd = daysInMonth;
  weeks.push({ start: 1, end: firstWeekEnd });

  let day = firstWeekEnd + 1;
  while (day <= daysInMonth) {
    const end = Math.min(day + 6, daysInMonth);
    weeks.push({ start: day, end: end });
    day = end + 1;
  }

  const jornadaMap = { 100: 5, 80: 4, 60: 3 };
  const turnsPerFullWeek = jornadaMap[currentJornada] || 5;

  function countWorkdays(startDay, endDay) {
    let count = 0;
    for (let d = startDay; d <= endDay; d++) {
      const jsDay = new Date(currentYear, currentMonth, d).getDay();
      if (jsDay >= 1 && jsDay <= 5) count++;
    }
    return count;
  }

  function countHolidaysInRange(startDay, endDay) {
    let count = 0;
    for (let d = startDay; d <= endDay; d++) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow >= 1 && dow <= 5) {
        if (isHoliday(currentYear, currentMonth, d) || isInferredHoliday(currentYear, currentMonth, d)) {
          count++;
        }
      }
    }
    return count;
  }

  let totalTurns = 0;
  let totalExpected = 0;
  let totalHolidays = 0;
  let html = '';

  const dayNames = ['Dom', 'Lun', 'Mar', 'Mi\u00e9', 'Jue', 'Vie', 'S\u00e1b'];

  weeks.forEach((w, i) => {
    const weekEntries = entries.filter(e => {
      if (e.day < w.start || e.day > w.end) return false;
      if (e.activity === 'localizado') return false;
      const dow = new Date(currentYear, currentMonth, e.day).getDay();
      return dow >= 1 && dow <= 5;
    });
    const weekTurns = weekEntries.length;
    totalTurns += weekTurns;
    const workdays = countWorkdays(w.start, w.end);
    const holidays = countHolidaysInRange(w.start, w.end);
    const effectiveWorkdays = workdays - holidays;
    totalExpected += turnsPerFullWeek * effectiveWorkdays / 5;
    totalHolidays += holidays;

    // Group entries by day for detail view
    const byDay = {};
    weekEntries.forEach(e => {
      if (!byDay[e.day]) byDay[e.day] = [];
      byDay[e.day].push(e.activity);
    });
    const sortedDays = Object.keys(byDay).map(Number).sort((a, b) => a - b);
    let daysHtml = '';
    for (const d of sortedDays) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      const acts = byDay[d].map(a => {
        const info = ACTIVITIES[a];
        return info ? `<span class="turn-day-dot" style="background:${info.color}"></span>${info.label}` : a;
      }).join(', ');
      daysHtml += `<div class="turn-day-item">${dayNames[dow]} ${d}: ${acts}</div>`;
    }

    const countClass = weekTurns > 0 ? 'turn-count' : 'turn-count-zero';
    const chevron = weekTurns > 0 ? '<span class="turn-chevron">\u25BC</span>' : '';
    const holidayNote = holidays > 0 ? ` <span style="font-size:10px;color:var(--text-light);font-weight:400;">(${holidays} festivo${holidays > 1 ? 's' : ''})</span>` : '';
    html += `
      <div class="turn-row${weekTurns > 0 ? '' : ''}" ${weekTurns > 0 ? 'onclick="this.classList.toggle(\'open\')"' : ''}>
        <div class="turn-row-header">
          <span>
            <span class="turn-week-label">Semana ${i + 1}</span>
            <span class="turn-week-range">(${w.start}-${w.end})</span>${holidayNote}
          </span>
          <span class="${countClass}">${weekTurns} turno${weekTurns !== 1 ? 's' : ''} ${chevron}</span>
        </div>
        ${weekTurns > 0 ? `<div class="turn-days">${daysHtml}</div>` : ''}
      </div>`;
  });

  const roundedExpected = Math.round(totalExpected);

  html += `
    <div class="turn-total">
      <span class="turn-total-label">Total ${MONTH_NAMES[currentMonth]}</span>
      <span>${totalTurns} turnos</span>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:12px;color:var(--text-muted);">
      <span>Esperados (jornada ${currentJornada}%${totalHolidays > 0 ? ', ' + totalHolidays + ' festivo' + (totalHolidays > 1 ? 's' : '') : ''})</span>
      <span style="font-weight:600;">${roundedExpected} turnos</span>
    </div>`;

  container.innerHTML = html;
}

// ─────────────────────────────────────────────
//  JORNADA TOGGLE
// ─────────────────────────────────────────────
document.querySelectorAll('#jornada-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#jornada-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentJornada = parseInt(this.dataset.jornada, 10);
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid)) {
      renderTurns(sid);
      if (chartsExpanded) renderCharts(sid);
    }
  });
});

// ─────────────────────────────────────────────
//  RETRIBUTION
// ─────────────────────────────────────────────
function renderRetribution(surgeonId) {
  const container = document.getElementById('retrib-content');
  const entries = (parsedData[surgeonId] || []).filter(
    e => e.month === currentMonth && e.year === currentYear
  );

  let g17 = 0, g24 = 0, l17 = 0, l24 = 0;
  for (const e of entries) {
    if (e.activity === 'guardia') {
      if (isNonWorkingDay(e.year, e.month, e.day)) g24++; else g17++;
    } else if (e.activity === 'localizado') {
      if (isNonWorkingDay(e.year, e.month, e.day)) l24++; else l17++;
    }
  }

  const R = RETRIB_RATES;
  const brutoG17 = g17 * R.gpf.r17 * R.gpf.h17;
  const brutoG24 = g24 * R.gpf.r24 * R.gpf.h24;
  const brutoL17 = l17 * R.loc.m17 * R.loc.e17;
  const brutoL24 = l24 * R.loc.m24 * R.loc.e24;
  const totalBruto = brutoG17 + brutoG24 + brutoL17 + brutoL24;
  const irpf = DEFAULT_IRPF;
  const totalNeto = totalBruto * (100 - irpf) / 100;

  const fmt = n => n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' \u20ac';

  // Update calculator link
  const calcLink = document.getElementById('retrib-calc-link');
  calcLink.href = `https://jmacot.github.io/calculadora-guardias/?tab=hsjd&gpf17=${g17}&gpf24=${g24}&hsjd17=${l17}&hsjd24=${l24}`;

  let html = '<table class="retrib-table"><thead><tr><th>Concepto</th><th>17h</th><th>24h</th><th>' + (retribMode === 'contaje' ? 'Total' : 'Subtotal') + '</th></tr></thead><tbody>';

  if (retribMode === 'contaje') {
    html += `<tr><td>\ud83d\ude91 Guardias</td><td>${g17}</td><td>${g24}</td><td style="font-weight:700">${g17 + g24}</td></tr>`;
    html += `<tr><td>\ud83d\udcde Localizados</td><td>${l17}</td><td>${l24}</td><td style="font-weight:700">${l17 + l24}</td></tr>`;
    html += `</tbody><tfoot><tr><td>Total</td><td>${g17 + l17}</td><td>${g24 + l24}</td><td>${g17 + g24 + l17 + l24}</td></tr></tfoot>`;
  } else if (retribMode === 'bruto') {
    html += `<tr><td>\ud83d\ude91 Guardias</td><td>${fmt(brutoG17)}</td><td>${fmt(brutoG24)}</td><td style="font-weight:700">${fmt(brutoG17 + brutoG24)}</td></tr>`;
    html += `<tr><td>\ud83d\udcde Localizados</td><td>${fmt(brutoL17)}</td><td>${fmt(brutoL24)}</td><td style="font-weight:700">${fmt(brutoL17 + brutoL24)}</td></tr>`;
    html += `</tbody><tfoot><tr><td>Total Bruto</td><td></td><td></td><td>${fmt(totalBruto)}</td></tr></tfoot>`;
  } else {
    const netoG17 = brutoG17 * (100 - irpf) / 100;
    const netoG24 = brutoG24 * (100 - irpf) / 100;
    const netoL17 = brutoL17 * (100 - irpf) / 100;
    const netoL24 = brutoL24 * (100 - irpf) / 100;
    html += `<tr><td>\ud83d\ude91 Guardias</td><td>${fmt(netoG17)}</td><td>${fmt(netoG24)}</td><td style="font-weight:700">${fmt(netoG17 + netoG24)}</td></tr>`;
    html += `<tr><td>\ud83d\udcde Localizados</td><td>${fmt(netoL17)}</td><td>${fmt(netoL24)}</td><td style="font-weight:700">${fmt(netoL17 + netoL24)}</td></tr>`;
    html += `</tbody><tfoot><tr><td>Total Neto (IRPF ${irpf}%)</td><td></td><td></td><td>${fmt(totalNeto)}</td></tr></tfoot>`;
  }

  html += '</table>';
  container.innerHTML = html;
}

document.querySelectorAll('#retrib-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#retrib-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    retribMode = this.dataset.mode;
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid)) renderRetribution(sid);
  });
});

// ─────────────────────────────────────────────
//  LEGEND
// ─────────────────────────────────────────────
function renderLegend() {
  const legend = document.getElementById('legend');
  let html = '';
  for (const [key, info] of Object.entries(ACTIVITIES)) {
    html += `<div class="legend-item"><span class="legend-dot" style="background:${info.color}"></span>${info.label}</div>`;
  }
  legend.innerHTML = html;
}

// ─────────────────────────────────────────────
//  CHARTS / DASHBOARD
// ─────────────────────────────────────────────
const ACTIVITY_COLORS = {
  diferida: '#64748b', qui_m: '#1a3a5c', cons_m: '#16a34a',
  saliente: '#f59e0b', cons_t: '#0d9488', qui_t: '#3b82f6',
  guardia: '#dc2626', localizado: '#7c3aed', gestion: '#ca8a04',
  diferida_t: '#94a3b8', rucot: '#e11d48'
};

let comparativaMode = 'turnos';
let qxUnitMode = 'total';
let comparadorMode = 'cirujano';
let retribMode = 'contaje';

// ── Interactive Comparator state ──
let icompMode = 'cirujano';
let icompPeriod = 'month';
let icompViz = 'slope';
let icompSelectedSurgeons = [];
let icompSelectedUnits = [];
let icompSelectedMetrics = ['guardia','qui_m','qui_t','cons_m','cons_t','gestion','localizado','diferida'];
const ICOMP_COLORS = ['#1a3a5c', '#16a34a', '#dc2626'];
const ICOMP_COLORS_DARK = ['#60a5fa', '#4ade80', '#f87171'];
const ICOMP_METRICS = [
  { key: 'guardia',    label: 'Guardias',   fn: e => e.activity === 'guardia' },
  { key: 'qui_m',      label: 'Qx Ma\u00f1ana',  fn: e => e.activity === 'qui_m' },
  { key: 'qui_t',      label: 'Qx Tarde',   fn: e => e.activity === 'qui_t' },
  { key: 'cons_m',     label: 'Consultas M', fn: e => e.activity === 'cons_m' },
  { key: 'cons_t',     label: 'Consultas T', fn: e => e.activity === 'cons_t' },
  { key: 'gestion',    label: 'Gesti\u00f3n',    fn: e => e.activity === 'gestion' },
  { key: 'localizado', label: 'Localizados', fn: e => e.activity === 'localizado' },
  { key: 'diferida',   label: 'Diferida',   fn: e => e.activity === 'diferida' || e.activity === 'diferida_t' }
];

// ── Retribution rates (HSJD) ──
const RETRIB_RATES = {
  gpf: { r17: 21.31, h17: 17, r24: 20.01, h24: 24 },
  loc: { m17: 8.5, e17: 21.31, m24: 12, e24: 20.01 }
};
const DEFAULT_IRPF = 15;

function getChartTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  return {
    textColor: isDark ? '#94a3b8' : '#555555',
    gridColor: isDark ? 'rgba(75,85,99,0.3)' : 'rgba(0,0,0,0.06)',
    surfaceColor: isDark ? '#1f2937' : '#ffffff',
    borderColor: isDark ? '#374151' : '#e5e7eb',
    accentColor: isDark ? '#60a5fa' : '#1a3a5c',
    isDark
  };
}

function destroyCharts() {
  document.querySelectorAll('.d3-chart-wrap').forEach(el => el.innerHTML = '');
  const deltaEl = document.getElementById('icomp-delta');
  if (deltaEl) deltaEl.innerHTML = '';
}

function getSurnameOf(id) {
  const name = SURGEONS[id] || `T${id}`;
  return name.split(' ').pop();
}

function getMonthEntries(surgeonId) {
  return (parsedData[surgeonId] || []).filter(
    e => e.month === currentMonth && e.year === currentYear
  );
}

function calcPercentile(val, allVals) {
  if (allVals.length <= 1) return 50;
  const below = allVals.filter(v => v < val).length;
  const equal = allVals.filter(v => v === val).length;
  return Math.round(((below + equal * 0.5) / allVals.length) * 100);
}

// ─────────────────────────────────────────────
//  D3 UTILITIES
// ─────────────────────────────────────────────
const d3Tooltip = { el: null };
function showD3Tooltip(event, html) {
  if (!d3Tooltip.el) d3Tooltip.el = d3.select('#d3-tooltip');
  d3Tooltip.el.html(html)
    .style('left', (event.clientX + 14) + 'px')
    .style('top', (event.clientY - 10) + 'px')
    .classed('visible', true);
}
function hideD3Tooltip() {
  if (d3Tooltip.el) d3Tooltip.el.classed('visible', false);
}

function createSVG(containerId, width, height) {
  const container = d3.select('#' + containerId);
  container.html('');
  return container.append('svg')
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');
}

function addGradient(svg, id, color, horizontal) {
  const defs = svg.select('defs').empty() ? svg.append('defs') : svg.select('defs');
  const grad = defs.append('linearGradient').attr('id', id)
    .attr('x1', '0%').attr('y1', '0%')
    .attr('x2', horizontal ? '100%' : '0%').attr('y2', horizontal ? '0%' : '100%');
  const c = d3.color(color);
  grad.append('stop').attr('offset', '0%').attr('stop-color', c.brighter(0.4));
  grad.append('stop').attr('offset', '100%').attr('stop-color', c.darker(0.15));
  return `url(#${id})`;
}

function d3HorizontalBar({ containerId, data, theme, surgeonId, accentColor, label }) {
  const margin = { top: 8, right: 50, bottom: 24, left: 80 };
  const barH = 26, gap = 4;
  const width = 400;
  const height = margin.top + margin.bottom + data.length * (barH + gap);
  const innerW = width - margin.left - margin.right;
  const innerH = height - margin.top - margin.bottom;

  const svg = createSVG(containerId, width, height);
  svg.append('defs');

  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const x = d3.scaleLinear().domain([0, d3.max(data, d => d.value) || 1]).nice().range([0, innerW]);
  const y = d3.scaleBand().domain(data.map(d => d.label)).range([0, innerH]).padding(0.15);

  // Grid lines
  g.append('g').attr('class', 'grid')
    .attr('transform', `translate(0,${innerH})`)
    .call(d3.axisBottom(x).ticks(5).tickSize(-innerH).tickFormat(''))
    .call(g2 => g2.select('.domain').remove())
    .call(g2 => g2.selectAll('.tick line').attr('stroke', theme.gridColor));

  // X axis
  g.append('g').attr('transform', `translate(0,${innerH})`)
    .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d')))
    .call(g2 => g2.select('.domain').remove())
    .call(g2 => g2.selectAll('text').attr('fill', theme.textColor).style('font-size', '10px').style('font-family', "'Inter',sans-serif"));

  // Bars — all bars get gradients; highlighted surgeon uses accent, others use a lighter tint
  const accentD3 = d3.color(accentColor);
  const mutedColor = theme.isDark
    ? d3.color(accentColor).copy({ opacity: 0.35 })
    : d3.hsl(accentD3).copy({ s: 0.18, l: 0.72 });
  const bars = g.selectAll('.bar').data(data).enter().append('g');

  bars.each(function(d, i) {
    const isMe = d.id === surgeonId;
    const gradId = `grad-${containerId}-${i}`;
    const fill = addGradient(svg, gradId, isMe ? accentColor : mutedColor.formatHex(), true);

    d3.select(this).append('rect')
      .attr('x', 0).attr('y', y(d.label))
      .attr('height', y.bandwidth()).attr('rx', 3)
      .attr('fill', fill)
      .attr('width', 0)
      .on('mouseover', (ev) => showD3Tooltip(ev, `<strong>${SURGEONS[d.id] || d.label}</strong><br>${label}: ${d.value}`))
      .on('mousemove', (ev) => showD3Tooltip(ev, `<strong>${SURGEONS[d.id] || d.label}</strong><br>${label}: ${d.value}`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 35).ease(d3.easeCubicOut)
      .attr('width', x(d.value));
  });

  // Value labels
  bars.append('text')
    .attr('x', d => x(d.value) + 5)
    .attr('y', d => y(d.label) + y.bandwidth() / 2)
    .attr('dy', '0.35em')
    .attr('fill', theme.textColor).style('font-size', '10px').style('font-weight', '600')
    .style('font-family', "'Inter',sans-serif")
    .style('opacity', 0)
    .text(d => d.value)
    .transition().duration(400).delay((d, i) => i * 35 + 300)
    .style('opacity', 1);

  // Y axis labels
  g.selectAll('.y-label').data(data).enter().append('text')
    .attr('x', -6).attr('y', d => y(d.label) + y.bandwidth() / 2)
    .attr('dy', '0.35em').attr('text-anchor', 'end')
    .attr('fill', d => d.id === surgeonId ? accentColor : theme.textColor)
    .style('font-size', '10px')
    .style('font-weight', d => d.id === surgeonId ? '700' : '400')
    .style('font-family', "'Inter',sans-serif")
    .text(d => d.label);
}

// ── Bubbles Chart (HTML-based) ──
function renderBubblesChart(surgeonId) {
  const container = document.getElementById('bubbles-container');
  const entries = getMonthEntries(surgeonId);
  if (entries.length === 0) {
    container.innerHTML = '<div style="color:var(--text-light);font-size:12px;text-align:center;padding:20px">Sin datos</div>';
    return;
  }
  // Aggregate into groups
  const grpMap = {
    qui_m:'quirofano', qui_t:'quirofano',
    cons_m:'consultas', cons_t:'consultas',
    diferida:'diferida_planta', diferida_t:'diferida_planta',
    guardia:'guardia', localizado:'localizado',
    gestion:'gestion', rucot:'rucot', saliente:'saliente'
  };
  const grpLabels = {
    quirofano:'Quir\u00f3fano', consultas:'Consultas', guardia:'Guardia',
    localizado:'Localizado', gestion:'Gesti\u00f3n',
    diferida_planta:'Diferida/Planta', rucot:'RUCOT', saliente:'Saliente'
  };
  const grpColors = {
    quirofano:'#1a3a5c', consultas:'#16a34a', guardia:'#dc2626',
    localizado:'#7c3aed', gestion:'#ca8a04',
    diferida_planta:'#64748b', rucot:'#e11d48', saliente:'#f59e0b'
  };
  const counts = {};
  entries.forEach(e => {
    const g = grpMap[e.activity] || e.activity;
    counts[g] = (counts[g] || 0) + 1;
  });
  const total = entries.length;
  const sorted = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
  const maxPct = Math.round(counts[sorted[0]] / total * 100);

  let bubblesHtml = '';
  for (const grp of sorted) {
    const pct = Math.round(counts[grp] / total * 100);
    const color = grpColors[grp] || '#999';
    const label = grpLabels[grp] || grp;
    const diam = Math.max(36, Math.round(36 + 74 * Math.sqrt(pct / Math.max(maxPct, 1))));
    const fontSize = diam < 50 ? 10 : (diam < 70 ? 12 : 14);
    bubblesHtml += `<div class="bubble" data-label="${label}: ${counts[grp]}" style="width:${diam}px;height:${diam}px;background:${color};font-size:${fontSize}px" title="${label}: ${counts[grp]} (${pct}%)">${pct}%</div>`;
  }
  container.innerHTML = bubblesHtml;
  // Click handler: toggle activity label below bubble
  container.querySelectorAll('.bubble').forEach(b => {
    b.addEventListener('click', () => {
      const existing = b.querySelector('.bubble-label');
      // Remove all labels first
      container.querySelectorAll('.bubble-label').forEach(l => l.remove());
      // Toggle: if this bubble already had a label, just remove it
      if (existing) return;
      const lbl = document.createElement('span');
      lbl.className = 'bubble-label';
      lbl.textContent = b.dataset.label;
      b.appendChild(lbl);
    });
  });
}

// ── Percentiles Card ──
function renderPercentilesCard(surgeonId) {
  const container = document.getElementById('percentiles-content');
  const units = SURGEON_UNITS[surgeonId];
  const unit = units ? units[0] : null;

  const metrics = [
    { key: 'guardia',    label: 'Guardias',         fn: e => e.activity === 'guardia' },
    { key: 'qui_total',  label: 'Quir\u00f3fanos Total',  fn: e => e.activity === 'qui_m' || e.activity === 'qui_t' },
    { key: 'qui_m',      label: 'Qx Ma\u00f1ana',         fn: e => e.activity === 'qui_m' },
    { key: 'qui_t',      label: 'Qx Tarde',          fn: e => e.activity === 'qui_t' },
    { key: 'cons_m',     label: 'Consultas M',       fn: e => e.activity === 'cons_m' },
    { key: 'cons_t',     label: 'Consultas T',       fn: e => e.activity === 'cons_t' },
    { key: 'gestion',    label: 'Gesti\u00f3n',           fn: e => e.activity === 'gestion' },
    { key: 'localizado', label: 'Localizados',       fn: e => e.activity === 'localizado' },
    { key: 'diferida',   label: 'Diferida/Planta',   fn: e => e.activity === 'diferida' || e.activity === 'diferida_t' },
    { key: 'turnos',     label: 'Turnos Totales',    fn: () => true }
  ];

  const allIds = Object.keys(parsedData).map(Number);
  const unitIds = unit ? getSurgeonsByUnit(unit).filter(id => parsedData[id]) : [];

  // Calculate counts for all surgeons
  const sCounts = {};
  for (const id of allIds) {
    const ent = getMonthEntries(id);
    sCounts[id] = {};
    for (const m of metrics) sCounts[id][m.key] = ent.filter(m.fn).length;
  }

  function buildPercPhrase(pct, scope, label) {
    const lab = label.toLowerCase();
    if (pct >= 50) {
      return `En ${scope}, percentil ${pct}: solo el ${100 - pct}% hace m\u00e1s ${lab} que t\u00fa.`;
    } else {
      return `En ${scope}, percentil ${pct}: el ${100 - pct}% hace m\u00e1s ${lab} que t\u00fa.`;
    }
  }

  function buildPercTip(label, val, pUnit, pGlobal) {
    let tip = `Tienes ${val} ${label.toLowerCase()} este mes.`;
    if (pUnit !== null) {
      tip += ' ' + buildPercPhrase(pUnit, 'tu unidad', label);
    }
    tip += ' ' + buildPercPhrase(pGlobal, 'el global', label);
    return tip;
  }

  let html = `<table class="perc-table"><thead><tr><th>M\u00e9trica</th><th style="text-align:center">Total</th>`;
  if (unit) html += `<th>P. Unidad</th>`;
  html += `<th>P. Global</th><th></th></tr></thead><tbody>`;

  for (const m of metrics) {
    const val = sCounts[surgeonId]?.[m.key] || 0;
    const globalVals = allIds.map(id => sCounts[id]?.[m.key] || 0);
    const gPct = calcPercentile(val, globalVals);
    const gColor = gPct >= 75 ? '#16a34a' : gPct >= 50 ? '#ca8a04' : gPct >= 25 ? '#f59e0b' : '#dc2626';

    let unitHtml = '';
    let uPct = null;
    if (unit) {
      const unitVals = unitIds.map(id => sCounts[id]?.[m.key] || 0);
      uPct = calcPercentile(val, unitVals);
      const uColor = uPct >= 75 ? '#16a34a' : uPct >= 50 ? '#ca8a04' : uPct >= 25 ? '#f59e0b' : '#dc2626';
      unitHtml = `<td><div class="sparkbar-wrap"><div class="sparkbar"><div class="sparkbar-fill p-unit" style="width:${uPct}%;background:${uColor}"></div></div><span class="sparkbar-pct" style="color:${uColor}">P${uPct}</span></div></td>`;
    }

    const tipText = buildPercTip(m.label, val, uPct, gPct);
    html += `<tr><td>${m.label}</td><td style="font-weight:700;text-align:center">${val}</td>${unitHtml}<td><div class="sparkbar-wrap"><div class="sparkbar"><div class="sparkbar-fill p-global" style="width:${gPct}%;background:${gColor}"></div></div><span class="sparkbar-pct" style="color:${gColor}">P${gPct}</span></div></td><td class="perc-info" tabindex="0">\u24d8<span class="perc-tip">${tipText}</span></td></tr>`;
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

// ── Radar — Perfil del Cirujano ──
function d3Radar({ containerId, labels, surgeonVals, avgVals, surgeonName, theme }) {
  const size = 280, cx = size / 2, cy = size / 2 - 10, radius = 100;
  const n = labels.length;
  const angleSlice = (2 * Math.PI) / n;
  const maxVal = Math.max(d3.max(surgeonVals), d3.max(avgVals), 1);
  const rScale = d3.scaleLinear().domain([0, maxVal]).range([0, radius]);

  const svg = createSVG(containerId, size, size + 40);
  const g = svg.append('g').attr('transform', `translate(${cx},${cy + 10})`);

  // Concentric rings
  const levels = 4;
  for (let i = 1; i <= levels; i++) {
    g.append('circle').attr('r', radius * i / levels)
      .attr('fill', 'none').attr('stroke', theme.gridColor).attr('stroke-dasharray', '2,3');
  }

  // Axis lines + labels
  labels.forEach((lbl, i) => {
    const angle = angleSlice * i - Math.PI / 2;
    const lx = Math.cos(angle) * radius, ly = Math.sin(angle) * radius;
    g.append('line').attr('x1', 0).attr('y1', 0).attr('x2', lx).attr('y2', ly)
      .attr('stroke', theme.gridColor).attr('stroke-width', 0.5);
    const lbx = Math.cos(angle) * (radius + 14), lby = Math.sin(angle) * (radius + 14);
    g.append('text').attr('x', lbx).attr('y', lby)
      .attr('text-anchor', 'middle').attr('dy', '0.35em')
      .attr('fill', theme.textColor).style('font-size', '9px').style('font-weight', '500')
      .style('font-family', "'Inter',sans-serif").text(lbl);
  });

  // Path generator
  const lineFn = d3.lineRadial().angle((d, i) => angleSlice * i).radius(d => rScale(d)).curve(d3.curveCardinalClosed.tension(0.3));

  // Average path
  const avgColor = theme.isDark ? '#fbbf24' : '#9ca3af';
  g.append('path').datum(avgVals)
    .attr('d', lineFn).attr('fill', theme.isDark ? 'rgba(251,191,36,0.12)' : 'rgba(107,107,107,0.08)')
    .attr('stroke', avgColor).attr('stroke-width', 1.5).attr('stroke-dasharray', '4,4');
  avgVals.forEach((v, i) => {
    const angle = angleSlice * i - Math.PI / 2;
    g.append('circle').attr('cx', Math.cos(angle) * rScale(v)).attr('cy', Math.sin(angle) * rScale(v))
      .attr('r', 2.5).attr('fill', avgColor)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${labels[i]}</strong><br>Media: ${v}`))
      .on('mouseout', hideD3Tooltip);
  });

  // Surgeon path
  const sColor = theme.accentColor;
  const sPath = g.append('path').datum(surgeonVals)
    .attr('fill', theme.isDark ? 'rgba(96,165,250,0.25)' : 'rgba(26,58,92,0.20)')
    .attr('stroke', sColor).attr('stroke-width', 2.5);
  // Animate
  const zeroVals = surgeonVals.map(() => 0);
  sPath.attr('d', lineFn(zeroVals)).transition().duration(700).ease(d3.easeCubicOut).attr('d', lineFn(surgeonVals));

  surgeonVals.forEach((v, i) => {
    const angle = angleSlice * i - Math.PI / 2;
    g.append('circle').attr('cx', Math.cos(angle) * rScale(v)).attr('cy', Math.sin(angle) * rScale(v))
      .attr('r', 3.5).attr('fill', sColor).attr('stroke', theme.surfaceColor).attr('stroke-width', 1.5)
      .style('opacity', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${labels[i]}</strong><br>${surgeonName}: ${v}`))
      .on('mouseout', hideD3Tooltip)
      .transition().delay(500).duration(300).style('opacity', 1);
  });

  // Legend
  const lg = svg.append('g').attr('transform', `translate(${cx - 80},${size + 18})`);
  [[sColor, surgeonName], [avgColor, 'Media servicio']].forEach(([c, txt], i) => {
    const gx = i * 100;
    lg.append('circle').attr('cx', gx).attr('cy', 0).attr('r', 4).attr('fill', c);
    lg.append('text').attr('x', gx + 8).attr('y', 0).attr('dy', '0.35em')
      .attr('fill', theme.textColor).style('font-size', '10px').style('font-family', "'Inter',sans-serif").text(txt);
  });
}

// ── d3SlopeChart: parallel coordinates / slope chart ──
function d3SlopeChart({ containerId, labels, datasets, theme }) {
  const n = labels.length;
  if (n < 2 || datasets.length < 2) return;
  const margin = { top: 44, right: 24, bottom: 40, left: 24 };
  const width = Math.max(460, n * 68);
  const axisH = 200;
  const height = margin.top + axisH + margin.bottom;
  const innerW = width - margin.left - margin.right;

  const svg = createSVG(containerId, width, height);
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  // X positions for each metric axis
  const xPositions = n === 1 ? [innerW / 2] : labels.map((_, i) => (innerW / (n - 1)) * i);

  // Per-axis Y scale — shared padding so dots don't touch top/bottom
  const yScales = labels.map((_, i) => {
    const vals = datasets.map(ds => ds.values[i]);
    const maxV = Math.max(d3.max(vals) || 0, 1);
    return d3.scaleLinear().domain([0, maxV * 1.1]).range([axisH, 0]);
  });

  // Vertical axis lines + labels
  labels.forEach((lbl, i) => {
    const x = xPositions[i];
    // Axis line
    g.append('line').attr('x1', x).attr('y1', 0).attr('x2', x).attr('y2', axisH)
      .attr('stroke', theme.gridColor).attr('stroke-width', 1).attr('stroke-dasharray', '3,3');

    // Metric label well above the chart — abbreviate if many axes
    const shortLbl = n >= 6 ? lbl.replace('Consultas', 'Cons.').replace('Localizados', 'Localiz.') : lbl;
    g.append('text').attr('x', x).attr('y', -28)
      .attr('text-anchor', 'middle').attr('fill', theme.textColor)
      .style('font-size', n >= 7 ? '8px' : '9px').style('font-weight', '700')
      .style('font-family', "'Inter',sans-serif")
      .style('text-transform', 'uppercase').style('letter-spacing', '0.3px')
      .text(shortLbl);

    // Max value small tick under label
    const maxV = yScales[i].domain()[1];
    const maxDisplay = Math.round(maxV / 1.1);
    g.append('text').attr('x', x).attr('y', -16)
      .attr('text-anchor', 'middle').attr('fill', theme.textColor)
      .style('font-size', '8px').style('opacity', 0.4)
      .style('font-family', "'Inter',sans-serif").text('max ' + maxDisplay);
  });

  // Draw lines + dots for each dataset
  const lineFn = d3.line().curve(d3.curveMonotoneX);

  datasets.forEach((ds, di) => {
    const points = ds.values.map((v, i) => [xPositions[i], yScales[i](v)]);

    // Line path with animated stroke drawing
    const path = g.append('path')
      .datum(points)
      .attr('d', lineFn)
      .attr('fill', 'none')
      .attr('stroke', ds.color)
      .attr('stroke-width', 2.5)
      .attr('stroke-linecap', 'round')
      .attr('stroke-linejoin', 'round');

    const totalLen = path.node().getTotalLength();
    path.attr('stroke-dasharray', totalLen)
      .attr('stroke-dashoffset', totalLen)
      .transition().duration(800).delay(di * 200).ease(d3.easeCubicOut)
      .attr('stroke-dashoffset', 0);

    // Dot markers + value labels
    ds.values.forEach((v, i) => {
      const cx = xPositions[i], cy = yScales[i](v);

      // Background pill for the value label
      const labelY = cy - 12;
      const textG = g.append('g').style('opacity', 0);
      textG.append('rect')
        .attr('x', cx - 12).attr('y', labelY - 7)
        .attr('width', 24).attr('height', 14)
        .attr('rx', 4).attr('fill', ds.color).attr('opacity', 0.15);
      textG.append('text')
        .attr('x', cx).attr('y', labelY)
        .attr('text-anchor', 'middle').attr('dy', '0.35em')
        .attr('fill', ds.color)
        .style('font-size', '9px').style('font-weight', '700')
        .style('font-family', "'Inter',sans-serif")
        .text(v);
      textG.transition().delay(di * 200 + 700).duration(300).style('opacity', 1);

      // Dot
      g.append('circle')
        .attr('cx', cx).attr('cy', cy)
        .attr('r', 5).attr('fill', ds.color)
        .attr('stroke', theme.surfaceColor).attr('stroke-width', 2)
        .style('opacity', 0)
        .on('mouseover', ev => showD3Tooltip(ev,
          `<strong>${ds.name}</strong><br>${labels[i]}: ${v}`))
        .on('mouseout', hideD3Tooltip)
        .transition().delay(di * 200 + 600).duration(300).style('opacity', 1);
    });
  });

  // Legend
  const lgWidth = datasets.length * 110;
  const lg = svg.append('g').attr('transform', `translate(${(width - lgWidth) / 2},${height - 10})`);
  datasets.forEach((ds, i) => {
    const gx = i * 110;
    lg.append('line').attr('x1', gx).attr('y1', 0).attr('x2', gx + 16).attr('y2', 0)
      .attr('stroke', ds.color).attr('stroke-width', 2.5).attr('stroke-linecap', 'round');
    lg.append('circle').attr('cx', gx + 8).attr('cy', 0).attr('r', 3.5).attr('fill', ds.color);
    lg.append('text').attr('x', gx + 22).attr('y', 0).attr('dy', '0.35em')
      .attr('fill', theme.textColor).style('font-size', '10px')
      .style('font-family', "'Inter',sans-serif").text(ds.name);
  });
}

// ── d3GroupedHorizontalBar: grouped bars per metric ──
function d3GroupedHorizontalBar({ containerId, metricLabels, datasets, theme }) {
  const nGroups = metricLabels.length;
  const nSeries = datasets.length;
  const margin = { top: 8, right: 50, bottom: 36, left: 90 };
  const subBarH = 16, subGap = 2, groupPad = 8;
  const groupH = nSeries * (subBarH + subGap) + groupPad;
  const width = 420;
  const height = margin.top + margin.bottom + nGroups * groupH;
  const innerW = width - margin.left - margin.right;
  const innerH = height - margin.top - margin.bottom;

  const svg = createSVG(containerId, width, height);
  svg.append('defs');
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const allVals = datasets.flatMap(d => d.values);
  const x = d3.scaleLinear().domain([0, d3.max(allVals) || 1]).nice().range([0, innerW]);
  const yGroup = d3.scaleBand().domain(metricLabels).range([0, innerH]).padding(0.15);
  const yBar = d3.scaleBand().domain(d3.range(nSeries)).range([0, yGroup.bandwidth()]).padding(0.08);

  // Grid lines
  g.append('g').attr('transform', `translate(0,${innerH})`)
    .call(d3.axisBottom(x).ticks(5).tickSize(-innerH).tickFormat(''))
    .call(g2 => { g2.select('.domain').remove(); g2.selectAll('.tick line').attr('stroke', theme.gridColor); });
  g.append('g').attr('transform', `translate(0,${innerH})`)
    .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d')))
    .call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size', '10px'); });

  // Bars
  metricLabels.forEach((metric, mi) => {
    datasets.forEach((ds, di) => {
      const val = ds.values[mi];
      const gradId = `grad-icomp-${mi}-${di}`;
      const fill = addGradient(svg, gradId, ds.color, true);
      g.append('rect')
        .attr('x', 0)
        .attr('y', yGroup(metric) + yBar(di))
        .attr('height', yBar.bandwidth())
        .attr('rx', 3)
        .attr('fill', fill)
        .attr('width', 0)
        .on('mouseover', ev => showD3Tooltip(ev, `<strong>${ds.name}</strong><br>${metric}: ${val}`))
        .on('mouseout', hideD3Tooltip)
        .transition().duration(500).delay(mi * 40 + di * 80).ease(d3.easeCubicOut)
        .attr('width', x(val));

      g.append('text')
        .attr('x', x(val) + 4)
        .attr('y', yGroup(metric) + yBar(di) + yBar.bandwidth() / 2)
        .attr('dy', '0.35em')
        .attr('fill', theme.textColor).style('font-size', '9px').style('font-weight', '600')
        .style('font-family', "'Inter',sans-serif").style('opacity', 0)
        .text(val)
        .transition().duration(300).delay(mi * 40 + di * 80 + 300).style('opacity', 1);
    });
  });

  // Y axis labels
  g.selectAll('.y-label').data(metricLabels).enter().append('text')
    .attr('x', -6)
    .attr('y', m => yGroup(m) + yGroup.bandwidth() / 2)
    .attr('dy', '0.35em').attr('text-anchor', 'end')
    .attr('fill', theme.textColor)
    .style('font-size', '10px').style('font-weight', '600')
    .style('font-family', "'Inter',sans-serif")
    .text(m => m);

  // Legend
  const lg = svg.append('g').attr('transform', `translate(${margin.left},${height - 12})`);
  let lx = 0;
  datasets.forEach(ds => {
    lg.append('circle').attr('cx', lx + 5).attr('cy', 0).attr('r', 4).attr('fill', ds.color);
    lg.append('text').attr('x', lx + 14).attr('y', 0).attr('dy', '0.35em')
      .attr('fill', theme.textColor).style('font-size', '10px')
      .style('font-family', "'Inter',sans-serif").text(ds.name);
    lx += ds.name.length * 7 + 28;
  });
}

function renderRadarChart(surgeonId) {
  const theme = getChartTheme();
  const radarMetrics = [
    { label: 'Guardias', fn: e => e.activity === 'guardia' },
    { label: 'Qx Mañana', fn: e => e.activity === 'qui_m' },
    { label: 'Qx Tarde', fn: e => e.activity === 'qui_t' },
    { label: 'Consultas M', fn: e => e.activity === 'cons_m' },
    { label: 'Consultas T', fn: e => e.activity === 'cons_t' },
    { label: 'Gestión', fn: e => e.activity === 'gestion' },
    { label: 'Localizados', fn: e => e.activity === 'localizado' },
    { label: 'Diferida', fn: e => e.activity === 'diferida' || e.activity === 'diferida_t' }
  ];
  const allIds = Object.keys(parsedData).map(Number);
  const surgeonVals = radarMetrics.map(m => getMonthEntries(surgeonId).filter(m.fn).length);
  const avgVals = radarMetrics.map(m => {
    const total = allIds.reduce((sum, id) => sum + getMonthEntries(id).filter(m.fn).length, 0);
    return Math.round((total / allIds.length) * 10) / 10;
  });
  d3Radar({ containerId: 'chart-radar', labels: radarMetrics.map(m => m.label), surgeonVals, avgVals, surgeonName: getSurnameOf(surgeonId), theme });
}

function renderRadarTotalChart(surgeonId) {
  const theme = getChartTheme();
  const radarMetrics = [
    { label: 'Guardias', fn: e => e.activity === 'guardia' },
    { label: 'Qx Mañana', fn: e => e.activity === 'qui_m' },
    { label: 'Qx Tarde', fn: e => e.activity === 'qui_t' },
    { label: 'Consultas M', fn: e => e.activity === 'cons_m' },
    { label: 'Consultas T', fn: e => e.activity === 'cons_t' },
    { label: 'Gestión', fn: e => e.activity === 'gestion' },
    { label: 'Localizados', fn: e => e.activity === 'localizado' },
    { label: 'Diferida', fn: e => e.activity === 'diferida' || e.activity === 'diferida_t' }
  ];
  const allIds = Object.keys(parsedData).map(Number);
  const surgeonVals = radarMetrics.map(m => (parsedData[surgeonId] || []).filter(m.fn).length);
  const avgVals = radarMetrics.map(m => {
    const total = allIds.reduce((sum, id) => sum + (parsedData[id] || []).filter(m.fn).length, 0);
    return Math.round((total / allIds.length) * 10) / 10;
  });
  d3Radar({ containerId: 'chart-radar-total', labels: radarMetrics.map(m => m.label), surgeonVals, avgVals, surgeonName: getSurnameOf(surgeonId), theme });
}

// ── Comparativa Unidad (with toggle: Turnos / Guardias) ──
function renderUnitComparisonChart(surgeonId) {
  const container = document.getElementById('chart-unit-comparison');
  const theme = getChartTheme();
  const units = SURGEON_UNITS[surgeonId];
  const titleEl = document.getElementById('comparativa-title');

  if (!units) { container.innerHTML = ''; titleEl.textContent = 'Unidad (sin asignar)'; return; }
  const unit = units[0];
  titleEl.textContent = `Unidad de ${unit}`;
  const unitSurgeons = getSurgeonsByUnit(unit).filter(id => parsedData[id]);
  const exclude = new Set(['guardia', 'saliente']);

  if (comparativaMode === 'guardias') {
    const guardCounts = {};
    for (const id of unitSurgeons) guardCounts[id] = getMonthEntries(id).filter(e => e.activity === 'guardia').length;
    unitSurgeons.sort((a, b) => guardCounts[b] - guardCounts[a]);
    d3HorizontalBar({ containerId: 'chart-unit-comparison', data: unitSurgeons.map(id => ({ label: getSurnameOf(id), value: guardCounts[id], id })), theme, surgeonId, accentColor: theme.accentColor, label: 'Guardias' });
  } else {
    const groupMap = { qui_m:'quirofano', qui_t:'quirofano', cons_m:'cons_m', cons_t:'cons_t', diferida:'diferida', diferida_t:'diferida_t', localizado:'localizado', gestion:'gestion', rucot:'rucot' };
    const groupLabels = { quirofano:'Quirófano', cons_m:'Consulta M', cons_t:'Consulta T', diferida:'Diferida', diferida_t:'Diferida T', localizado:'Localizado', gestion:'Gestión', rucot:'RUCOT' };
    const groupColors = { quirofano:'#1a3a5c', cons_m:ACTIVITY_COLORS['cons_m'], cons_t:ACTIVITY_COLORS['cons_t'], diferida:ACTIVITY_COLORS['diferida'], diferida_t:ACTIVITY_COLORS['diferida_t'], localizado:ACTIVITY_COLORS['localizado'], gestion:ACTIVITY_COLORS['gestion'], rucot:ACTIVITY_COLORS['rucot'] };

    const actCounts = {}; const allGroups = new Set();
    for (const id of unitSurgeons) {
      actCounts[id] = {};
      getMonthEntries(id).forEach(e => { if (exclude.has(e.activity)) return; const grp = groupMap[e.activity] || e.activity; actCounts[id][grp] = (actCounts[id][grp] || 0) + 1; allGroups.add(grp); });
    }
    unitSurgeons.sort((a,b) => { const ta = Object.values(actCounts[a]).reduce((s,v)=>s+v,0); const tb = Object.values(actCounts[b]).reduce((s,v)=>s+v,0); return tb-ta; });
    const grpOrder = ['quirofano','cons_m','cons_t','diferida','diferida_t','localizado','gestion','rucot'];
    const usedGrps = grpOrder.filter(g => allGroups.has(g));

    const legendRows = usedGrps.length > 4 ? 2 : 1;
    const margin = { top: 8, right: 30, bottom: 20 + legendRows * 18, left: 80 };
    const barH = 26, gap = 4;
    const width = 400, height = margin.top + margin.bottom + unitSurgeons.length * (barH + gap);
    const innerW = width - margin.left - margin.right, innerH = height - margin.top - margin.bottom;

    const svg = createSVG('chart-unit-comparison', width, height);
    svg.append('defs');
    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

    const y = d3.scaleBand().domain(unitSurgeons.map(id => getSurnameOf(id))).range([0, innerH]).padding(0.15);
    const maxTotal = d3.max(unitSurgeons, id => Object.values(actCounts[id]).reduce((s,v)=>s+v,0)) || 1;
    const x = d3.scaleLinear().domain([0, maxTotal]).nice().range([0, innerW]);

    g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(5).tickSize(-innerH).tickFormat('')).call(g2 => { g2.select('.domain').remove(); g2.selectAll('.tick line').attr('stroke', theme.gridColor); });
    g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d'))).call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size','10px'); });

    unitSurgeons.forEach((id, idx) => {
      const name = getSurnameOf(id); let cx = 0; const total = Object.values(actCounts[id]).reduce((s,v)=>s+v,0);
      usedGrps.forEach((grp, gi) => {
        const val = actCounts[id][grp] || 0; if (!val) return;
        const bw = x(val); const isMe = id === surgeonId;
        const gradId = `grad-comp-${idx}-${gi}`;
        const fill = addGradient(svg, gradId, groupColors[grp] || '#999', true);
        g.append('rect').attr('x', x(cx)).attr('y', y(name)).attr('height', y.bandwidth()).attr('rx', 2)
          .attr('fill', fill).attr('stroke', isMe ? theme.accentColor : 'none').attr('stroke-width', isMe ? 1.5 : 0)
          .attr('width', 0)
          .on('mouseover', ev => showD3Tooltip(ev, `<strong>${SURGEONS[id]}</strong><br>${groupLabels[grp]}: ${val} (${Math.round(val/total*100)}%)`))
          .on('mouseout', hideD3Tooltip)
          .transition().duration(500).delay(idx * 35).ease(d3.easeCubicOut).attr('width', bw);
        // % label inside segment
        const pct = Math.round(val/total*100);
        if (pct >= 12 && bw > 20) {
          g.append('text').attr('x', x(cx) + bw/2).attr('y', y(name) + y.bandwidth()/2).attr('dy','0.35em')
            .attr('text-anchor','middle').attr('fill','rgba(255,255,255,0.9)').style('font-size','8px').style('font-weight','700')
            .style('font-family',"'Inter',sans-serif").style('opacity',0).text(`${pct}%`)
            .transition().delay(idx*35+400).duration(200).style('opacity',1);
        }
        cx += val;
      });
    });

    // Y labels
    g.selectAll('.y-lbl').data(unitSurgeons).enter().append('text')
      .attr('x', -6).attr('y', id => y(getSurnameOf(id)) + y.bandwidth()/2).attr('dy','0.35em').attr('text-anchor','end')
      .attr('fill', id => id === surgeonId ? theme.accentColor : theme.textColor)
      .style('font-size','10px').style('font-weight', id => id === surgeonId ? '700':'400').style('font-family',"'Inter',sans-serif")
      .text(id => getSurnameOf(id));

    // Legend — wraps into rows if many groups
    const maxLegendW = innerW;
    const lg = svg.append('g').attr('transform', `translate(${margin.left},${height - legendRows * 18})`);
    let lx = 0, ly = 0;
    usedGrps.forEach(grp => {
      const itemW = (groupLabels[grp].length * 5.5) + 24;
      if (lx + itemW > maxLegendW && lx > 0) { lx = 0; ly += 16; }
      lg.append('rect').attr('x', lx).attr('y', ly - 5).attr('width', 10).attr('height', 10).attr('rx', 2).attr('fill', groupColors[grp]);
      lg.append('text').attr('x', lx + 14).attr('y', ly).attr('dy','0.35em').attr('fill', theme.textColor)
        .style('font-size','9px').style('font-family',"'Inter',sans-serif").text(groupLabels[grp]);
      lx += itemW;
    });
  }
}

// ── QX por Unidad (global) ──
function renderQxUnitChart(surgeonId) {
  const theme = getChartTheme();
  const allUnits = ['Rodilla', 'Cadera', 'Hombro', 'Mano', 'Pie', 'Trauma'];
  const selectedUnits = SURGEON_UNITS[surgeonId] || [];
  const unitCounts = {};
  for (const unit of allUnits) {
    let count = 0;
    const surgeons = getSurgeonsByUnit(unit).filter(id => parsedData[id]);
    for (const id of surgeons) {
      count += getMonthEntries(id).filter(e => {
        if (qxUnitMode === 'manana') return e.activity === 'qui_m';
        if (qxUnitMode === 'tarde') return e.activity === 'qui_t';
        return e.activity === 'qui_m' || e.activity === 'qui_t';
      }).length;
    }
    unitCounts[unit] = count;
  }
  const sorted = [...allUnits].sort((a, b) => unitCounts[b] - unitCounts[a]);
  const margin = { top: 10, right: 10, bottom: 30, left: 35 };
  const width = 360, height = 220;
  const innerW = width - margin.left - margin.right, innerH = height - margin.top - margin.bottom;

  const svg = createSVG('chart-qx-unit', width, height);
  svg.append('defs');
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand().domain(sorted).range([0, innerW]).padding(0.25);
  const maxV = d3.max(sorted, u => unitCounts[u]) || 1;
  const y = d3.scaleLinear().domain([0, maxV]).nice().range([innerH, 0]);

  // Grid
  g.append('g').call(d3.axisLeft(y).ticks(5).tickSize(-innerW).tickFormat('')).call(g2 => { g2.select('.domain').remove(); g2.selectAll('.tick line').attr('stroke', theme.gridColor); });
  g.append('g').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('d'))).call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size','10px'); });
  g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).tickSize(0)).call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size','10px').style('font-weight','600'); });

  const accentQx = d3.color(theme.accentColor);
  const mutedQx = theme.isDark
    ? d3.color(theme.accentColor).copy({ opacity: 0.35 })
    : d3.hsl(accentQx).copy({ s: 0.18, l: 0.72 });
  sorted.forEach((unit, i) => {
    const isMe = selectedUnits.includes(unit);
    const gradId = `grad-qx-${i}`;
    const fill = addGradient(svg, gradId, isMe ? theme.accentColor : mutedQx.formatHex(), false);
    g.append('rect').attr('x', x(unit)).attr('y', innerH).attr('width', x.bandwidth()).attr('rx', 4)
      .attr('fill', fill).attr('height', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${unit}</strong><br>Quirófanos: ${unitCounts[unit]}`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 60).ease(d3.easeCubicOut)
      .attr('y', y(unitCounts[unit])).attr('height', innerH - y(unitCounts[unit]));
    // Value label
    g.append('text').attr('x', x(unit) + x.bandwidth()/2).attr('y', y(unitCounts[unit]) - 6)
      .attr('text-anchor','middle').attr('fill', theme.textColor).style('font-size','10px').style('font-weight','700')
      .style('font-family',"'Inter',sans-serif").style('opacity',0).text(unitCounts[unit])
      .transition().delay(i*60+400).duration(200).style('opacity',1);
  });
}

// ── Ranking Guardias (global) ──
function renderRankingGuardiasChart(surgeonId) {
  const theme = getChartTheme();
  const counts = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    const g = getMonthEntries(id).filter(e => e.activity === 'guardia').length;
    if (g > 0) counts[id] = g;
  }
  const sorted = Object.keys(counts).map(Number).sort((a, b) => counts[b] - counts[a]).slice(0, 12);
  d3HorizontalBar({ containerId: 'chart-ranking-guardias', data: sorted.map(id => ({ label: getSurnameOf(id), value: counts[id], id })), theme, surgeonId, accentColor: '#dc2626', label: 'Guardias' });
}

function renderRankingLocalizadosChart(surgeonId) {
  const theme = getChartTheme();
  const counts = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    const g = getMonthEntries(id).filter(e => e.activity === 'localizado').length;
    if (g > 0) counts[id] = g;
  }
  const sorted = Object.keys(counts).map(Number).sort((a, b) => counts[b] - counts[a]).slice(0, 12);
  d3HorizontalBar({ containerId: 'chart-ranking-localizados', data: sorted.map(id => ({ label: getSurnameOf(id), value: counts[id], id })), theme, surgeonId, accentColor: '#7c3aed', label: 'Localizados' });
}

// ── Ranking Gestión (global, list with day details) ──
function renderRankingGestionChart(surgeonId) {
  const container = document.getElementById('ranking-gestion-content');

  const dayNames = ['Dom', 'Lun', 'Mar', 'Mi\u00e9', 'Jue', 'Vie', 'S\u00e1b'];
  const gestionData = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    const entries = getMonthEntries(id).filter(e => e.activity === 'gestion');
    if (entries.length > 0) {
      gestionData[id] = entries.map(e => {
        const dow = new Date(e.year, e.month, e.day).getDay();
        return { day: e.day, dowName: dayNames[dow] };
      }).sort((a, b) => a.day - b.day);
    }
  }
  const sorted = Object.keys(gestionData).map(Number)
    .sort((a, b) => gestionData[b].length - gestionData[a].length);

  if (sorted.length === 0) { document.getElementById('card-ranking-gestion').style.display = 'none'; return; }
  document.getElementById('card-ranking-gestion').style.display = '';

  let html = '<div class="rank-gestion-list">';
  sorted.forEach((id, i) => {
    const days = gestionData[id];
    const isMe = id === surgeonId;
    const daysStr = days.map(d => `${d.dowName} ${d.day}`).join(', ');
    html += `<div class="rank-gestion-item${isMe ? ' highlight' : ''}" onclick="this.classList.toggle('open')">
      <span class="rank-gestion-pos">${i + 1}</span>
      <span class="rank-gestion-name">${getSurnameOf(id)}</span>
      <span class="rank-gestion-count">${days.length} d\u00eda${days.length !== 1 ? 's' : ''}</span>
      <span class="rank-gestion-chevron">\u25BC</span>
      <div class="rank-gestion-days">${daysStr}</div>
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

// ── Ranking Actividad Total (global) ──
function renderRankingTurnosChart(surgeonId) {
  const theme = getChartTheme();
  const counts = {};
  for (const id of Object.keys(parsedData).map(Number)) counts[id] = getMonthEntries(id).length;
  const sorted = Object.keys(counts).map(Number).filter(id => counts[id] > 0).sort((a, b) => counts[b] - counts[a]).slice(0, 15);
  d3HorizontalBar({ containerId: 'chart-ranking-turnos', data: sorted.map(id => ({ label: getSurnameOf(id), value: counts[id], id })), theme, surgeonId, accentColor: theme.accentColor, label: 'Turnos' });
}

// ── Mañana vs Tarde chart ──
function renderMorningAfternoonChart(surgeonId) {
  const theme = getChartTheme();
  const morningActs = new Set(['qui_m', 'cons_m', 'diferida']);
  const afternoonActs = new Set(['qui_t', 'cons_t', 'diferida_t']);
  const stats = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    const entries = getMonthEntries(id);
    const m = entries.filter(e => morningActs.has(e.activity)).length;
    const t = entries.filter(e => afternoonActs.has(e.activity)).length;
    const total = m + t;
    if (total > 0) stats[id] = { m, t, total };
  }
  const sorted = Object.keys(stats).map(Number).sort((a, b) => stats[b].total - stats[a].total);
  if (sorted.length === 0) return;

  const margin = { top: 24, right: 30, bottom: 24, left: 80 };
  const barH = 24, gap = 4;
  const width = 440, height = margin.top + margin.bottom + sorted.length * (barH + gap);
  const innerW = width - margin.left - margin.right, innerH = height - margin.top - margin.bottom;

  const svg = createSVG('chart-morning-afternoon', width, height);
  svg.append('defs');
  const mColor = theme.isDark ? '#60a5fa' : '#0369a1';
  const tColor = theme.isDark ? '#fb923c' : '#c2410c';
  const mMuted = theme.isDark ? 'rgba(96,165,250,0.5)' : 'rgba(96,165,250,0.55)';
  const tMuted = theme.isDark ? 'rgba(251,146,60,0.4)' : 'rgba(251,146,60,0.45)';

  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
  const x = d3.scaleLinear().domain([0, 100]).range([0, innerW]);
  const y = d3.scaleBand().domain(sorted.map(id => getSurnameOf(id))).range([0, innerH]).padding(0.15);

  // X axis
  g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(5).tickFormat(v => v + '%')).call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size','10px'); });
  g.append('g').call(d3.axisBottom(x).ticks(5).tickSize(-innerH).tickFormat('')).call(g2 => { g2.select('.domain').remove(); g2.selectAll('.tick line').attr('stroke', theme.gridColor); });

  sorted.forEach((id, i) => {
    const s = stats[id]; const name = getSurnameOf(id); const isMe = id === surgeonId;
    const mPct = Math.round(s.m / s.total * 100); const tPct = 100 - mPct;

    // Morning bar
    const mGrad = addGradient(svg, `grad-m-${i}`, isMe ? mColor : mMuted, true);
    g.append('rect').attr('x', 0).attr('y', y(name)).attr('height', y.bandwidth()).attr('rx', 2)
      .attr('fill', mGrad).attr('width', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${SURGEONS[id]}</strong><br>Mañana: ${mPct}% (${s.m} turnos)<br>Tarde: ${tPct}% (${s.t} turnos)`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 25).ease(d3.easeCubicOut).attr('width', x(mPct));

    // Afternoon bar
    const tGrad = addGradient(svg, `grad-t-${i}`, isMe ? tColor : tMuted, true);
    g.append('rect').attr('x', x(mPct)).attr('y', y(name)).attr('height', y.bandwidth()).attr('rx', 2)
      .attr('fill', tGrad).attr('width', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${SURGEONS[id]}</strong><br>Mañana: ${mPct}% (${s.m} turnos)<br>Tarde: ${tPct}% (${s.t} turnos)`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 25).ease(d3.easeCubicOut).attr('width', x(tPct));

    // % labels inside bars
    if (mPct >= 15 && x(mPct) > 28) {
      g.append('text').attr('x', x(mPct) / 2).attr('y', y(name) + y.bandwidth()/2).attr('dy','0.35em')
        .attr('text-anchor','middle').attr('fill','rgba(255,255,255,0.9)').style('font-size','9px').style('font-weight','700')
        .style('font-family',"'Inter',sans-serif").style('opacity',0).text(`${mPct}%`)
        .transition().delay(i*25+400).duration(200).style('opacity',1);
    }
    if (tPct >= 15 && x(tPct) > 28) {
      g.append('text').attr('x', x(mPct) + x(tPct)/2).attr('y', y(name) + y.bandwidth()/2).attr('dy','0.35em')
        .attr('text-anchor','middle').attr('fill','rgba(255,255,255,0.9)').style('font-size','9px').style('font-weight','700')
        .style('font-family',"'Inter',sans-serif").style('opacity',0).text(`${tPct}%`)
        .transition().delay(i*25+400).duration(200).style('opacity',1);
    }
  });

  // Y labels
  g.selectAll('.y-lbl').data(sorted).enter().append('text')
    .attr('x', -6).attr('y', id => y(getSurnameOf(id)) + y.bandwidth()/2).attr('dy','0.35em').attr('text-anchor','end')
    .attr('fill', id => id === surgeonId ? mColor : theme.textColor)
    .style('font-size','10px').style('font-weight', id => id === surgeonId ? '700':'400').style('font-family',"'Inter',sans-serif")
    .text(id => getSurnameOf(id));

  // Legend
  const lg = svg.append('g').attr('transform', `translate(${margin.left + innerW/2 - 70},10)`);
  [[mColor, 'Mañana %'], [tColor, 'Tarde %']].forEach(([c, txt], i) => {
    lg.append('rect').attr('x', i*80).attr('y', -5).attr('width', 10).attr('height', 10).attr('rx', 2).attr('fill', c);
    lg.append('text').attr('x', i*80+14).attr('y', 0).attr('dy','0.35em').attr('fill', theme.textColor).style('font-size','10px').style('font-family',"'Inter',sans-serif").text(txt);
  });
}

// ── Festivos Trabajados chart ──
function renderFestivosChart(surgeonId) {
  const theme = getChartTheme();
  const stats = {};
  for (const id of Object.keys(parsedData).map(Number)) {
    const entries = getMonthEntries(id); let fiestas = 0, fines = 0; const seen = new Set();
    for (const e of entries) {
      const key = `${e.year}-${e.month}-${e.day}`; if (seen.has(key)) continue; seen.add(key);
      if (isHoliday(e.year, e.month, e.day) || isInferredHoliday(e.year, e.month, e.day)) fiestas++;
      else { const dow = new Date(e.year, e.month, e.day).getDay(); if (dow === 0 || dow === 6) fines++; }
    }
    const total = fiestas + fines; if (total > 0) stats[id] = { fiestas, fines, total };
  }
  const sorted = Object.keys(stats).map(Number).sort((a, b) => stats[b].total - stats[a].total).slice(0, 15);
  if (sorted.length === 0) { document.getElementById('card-festivos').style.display = 'none'; return; }
  document.getElementById('card-festivos').style.display = '';

  // Horizontal grouped bar chart for better surgeon identification
  const margin = { top: 24, right: 40, bottom: 24, left: 80 };
  const barH = 10, groupH = barH * 2 + 4, gap = 6;
  const width = 440, height = margin.top + margin.bottom + sorted.length * (groupH + gap);
  const innerW = width - margin.left - margin.right, innerH = height - margin.top - margin.bottom;

  const svg = createSVG('chart-festivos', width, height);
  svg.append('defs');
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const maxV = d3.max(sorted, id => Math.max(stats[id].fiestas, stats[id].fines)) || 1;
  const x = d3.scaleLinear().domain([0, maxV]).nice().range([0, innerW]);
  const y = d3.scaleBand().domain(sorted.map(id => getSurnameOf(id))).range([0, innerH]).padding(0.2);

  // Grid
  g.append('g').call(d3.axisBottom(x).ticks(5).tickSize(-innerH).tickFormat('')).call(g2 => { g2.select('.domain').remove(); g2.selectAll('.tick line').attr('stroke', theme.gridColor); });
  g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d'))).call(g2 => { g2.select('.domain').remove(); g2.selectAll('text').attr('fill', theme.textColor).style('font-size','10px'); });

  const festColor = '#dc2626', fineColor = '#7c3aed';

  sorted.forEach((id, i) => {
    const s = stats[id]; const name = getSurnameOf(id); const isMe = id === surgeonId;
    const yPos = y(name); const bw = y.bandwidth();

    // Festivos bar (top half)
    const fGrad = addGradient(svg, `grad-fest-${i}`, festColor, true);
    g.append('rect').attr('x', 0).attr('y', yPos).attr('height', bw / 2 - 1).attr('rx', 2)
      .attr('fill', fGrad).style('opacity', isMe ? 1 : 0.65).attr('width', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${SURGEONS[id]}</strong><br>Festivos: ${s.fiestas}<br>Fines semana: ${s.fines}<br>Total: ${s.total}`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 35).ease(d3.easeCubicOut).attr('width', x(s.fiestas));

    // Fines bar (bottom half)
    const wGrad = addGradient(svg, `grad-fine-${i}`, fineColor, true);
    g.append('rect').attr('x', 0).attr('y', yPos + bw / 2 + 1).attr('height', bw / 2 - 1).attr('rx', 2)
      .attr('fill', wGrad).style('opacity', isMe ? 1 : 0.65).attr('width', 0)
      .on('mouseover', ev => showD3Tooltip(ev, `<strong>${SURGEONS[id]}</strong><br>Festivos: ${s.fiestas}<br>Fines semana: ${s.fines}<br>Total: ${s.total}`))
      .on('mouseout', hideD3Tooltip)
      .transition().duration(500).delay(i * 35 + 60).ease(d3.easeCubicOut).attr('width', x(s.fines));

    // Value labels
    if (s.fiestas > 0) g.append('text').attr('x', x(s.fiestas)+4).attr('y', yPos + bw/4).attr('dy','0.35em').attr('fill', theme.textColor).style('font-size','9px').style('font-weight','600').style('opacity',0).text(s.fiestas).transition().delay(i*35+400).duration(200).style('opacity',1);
    if (s.fines > 0) g.append('text').attr('x', x(s.fines)+4).attr('y', yPos + bw*3/4).attr('dy','0.35em').attr('fill', theme.textColor).style('font-size','9px').style('font-weight','600').style('opacity',0).text(s.fines).transition().delay(i*35+460).duration(200).style('opacity',1);
  });

  // Y labels
  g.selectAll('.y-lbl').data(sorted).enter().append('text')
    .attr('x', -6).attr('y', id => y(getSurnameOf(id)) + y.bandwidth()/2).attr('dy','0.35em').attr('text-anchor','end')
    .attr('fill', id => id === surgeonId ? festColor : theme.textColor)
    .style('font-size','10px').style('font-weight', id => id === surgeonId ? '700':'400').style('font-family',"'Inter',sans-serif")
    .text(id => getSurnameOf(id));

  // Legend
  const lg = svg.append('g').attr('transform', `translate(${margin.left + innerW/2 - 90},10)`);
  [[festColor, 'Festivos'], [fineColor, 'Fines de semana']].forEach(([c, txt], i) => {
    lg.append('rect').attr('x', i*110).attr('y', -5).attr('width', 10).attr('height', 10).attr('rx', 2).attr('fill', c);
    lg.append('text').attr('x', i*110+14).attr('y', 0).attr('dy','0.35em').attr('fill', theme.textColor).style('font-size','10px').style('font-family',"'Inter',sans-serif").text(txt);
  });
}

// ── Comparador Table (by Cirujano or Unidad) ──
function countActivitiesOf(entries) {
  const qxM = entries.filter(e => e.activity === 'qui_m').length;
  const qxT = entries.filter(e => e.activity === 'qui_t').length;
  const consM = entries.filter(e => e.activity === 'cons_m').length;
  const consT = entries.filter(e => e.activity === 'cons_t').length;
  const gestion = entries.filter(e => e.activity === 'gestion').length;
  return { qxM, qxT, qxTotal: qxM + qxT, consM, consT, consTotal: consM + consT, gestion };
}

function buildComparadorHeader(firstCol) {
  return `<table class="comparador-table">
    <thead>
      <tr>
        <th rowspan="2">${firstCol}</th>
        <th colspan="5" class="th-group th-group-qx">Quir\u00f3fano</th>
        <th colspan="5" class="th-group th-group-cons">Consultas</th>
        <th rowspan="2" class="th-group th-group-gest">Gesti\u00f3n</th>
      </tr>
      <tr>
        <th class="th-sub">Ma\u00f1</th><th class="th-sub">Tarde</th>
        <th class="th-sub">Total</th><th class="th-sub">%M</th><th class="th-sub">%T</th>
        <th class="th-sub">Ma\u00f1</th><th class="th-sub">Tarde</th>
        <th class="th-sub">Total</th><th class="th-sub">%M</th><th class="th-sub">%T</th>
      </tr>
    </thead><tbody>`;
}

function buildComparadorRow(label, c, isHighlight, grandQx, grandCons) {
  const hl = isHighlight ? ' class="highlight"' : '';
  const qxMPct = c.qxTotal > 0 ? Math.round(c.qxM / c.qxTotal * 100) : 0;
  const qxTPct = c.qxTotal > 0 ? Math.round(c.qxT / c.qxTotal * 100) : 0;
  const consMPct = c.consTotal > 0 ? Math.round(c.consM / c.consTotal * 100) : 0;
  const consTPct = c.consTotal > 0 ? Math.round(c.consT / c.consTotal * 100) : 0;
  return `<tr${hl}>
    <td>${label}</td>
    <td>${c.qxM}</td><td>${c.qxT}</td>
    <td class="td-total">${c.qxTotal}</td><td class="td-pct">${qxMPct}%</td><td class="td-pct">${qxTPct}%</td>
    <td>${c.consM}</td><td>${c.consT}</td>
    <td class="td-total">${c.consTotal}</td><td class="td-pct">${consMPct}%</td><td class="td-pct">${consTPct}%</td>
    <td>${c.gestion}</td>
  </tr>`;
}

function renderComparadorChart(surgeonId) {
  const container = document.getElementById('comparador-content');
  const units = SURGEON_UNITS[surgeonId];

  if (comparadorMode === 'cirujano') {
    const unit = units ? units[0] : null;
    if (!unit) { container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);font-size:12px;">Sin unidad asignada</div>'; return; }
    const unitSurgeons = getSurgeonsByUnit(unit).filter(id => parsedData[id]);
    const rows = unitSurgeons.map(id => {
      const c = countActivitiesOf(getMonthEntries(id));
      return { id, name: getSurnameOf(id), ...c };
    }).sort((a, b) => (b.qxTotal + b.consTotal + b.gestion) - (a.qxTotal + a.consTotal + a.gestion));

    const grandQx = rows.reduce((s, r) => s + r.qxTotal, 0);
    const grandCons = rows.reduce((s, r) => s + r.consTotal, 0);
    let html = buildComparadorHeader(unit);
    for (const r of rows) {
      html += buildComparadorRow(r.name, r, r.id === surgeonId, grandQx, grandCons);
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  } else {
    const allUnits = ['Rodilla', 'Cadera', 'Hombro', 'Mano', 'Pie', 'Trauma'];
    const selectedUnits = units || [];
    const rows = allUnits.map(u => {
      const ids = getSurgeonsByUnit(u).filter(id => parsedData[id]);
      const allEntries = ids.flatMap(id => getMonthEntries(id));
      const c = countActivitiesOf(allEntries);
      return { unit: u, ...c, isHighlight: selectedUnits.includes(u) };
    });

    const grandQx = rows.reduce((s, r) => s + r.qxTotal, 0);
    const grandCons = rows.reduce((s, r) => s + r.consTotal, 0);
    let html = buildComparadorHeader('Unidad');
    for (const r of rows) {
      html += buildComparadorRow(r.unit, r, r.isHighlight, grandQx, grandCons);
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  }
}

// ── Interactive Comparator ──
function getIcompEntries(surgeonId) {
  if (icompPeriod === 'total') return parsedData[surgeonId] || [];
  return getMonthEntries(surgeonId);
}

function buildIcompSelector() {
  const container = document.getElementById('icomp-selector');
  if (!container) return;
  const theme = getChartTheme();
  const colors = theme.isDark ? ICOMP_COLORS_DARK : ICOMP_COLORS;

  if (icompMode === 'cirujano') {
    if (icompSelectedSurgeons.length === 0) {
      const sid = parseInt(document.getElementById('surgeon-select').value, 10);
      if (!isNaN(sid) && parsedData[sid]) icompSelectedSurgeons.push(sid);
    }
    const allIds = Object.keys(parsedData).map(Number)
      .sort((a, b) => (SURGEONS[a] || '').localeCompare(SURGEONS[b] || ''));
    const atMax = icompSelectedSurgeons.length >= 3;
    const count = icompSelectedSurgeons.length;

    let html = `<span class="icomp-hint">Pulsa para seleccionar 2-3 cirujanos (${count}/3)</span>`;
    html += '<div class="icomp-pill-grid">';
    allIds.forEach(id => {
      const isActive = icompSelectedSurgeons.includes(id);
      const idx = icompSelectedSurgeons.indexOf(id);
      const cls = isActive ? 'active' : (atMax ? 'disabled' : '');
      const bg = isActive ? `background:${colors[idx]};border-color:${colors[idx]};` : '';
      html += `<button class="icomp-surgeon-pill ${cls}" data-id="${id}" style="${bg}">${getSurnameOf(id)}</button>`;
    });
    html += '</div>';
    container.innerHTML = html;

    container.querySelectorAll('.icomp-surgeon-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id, 10);
        if (icompSelectedSurgeons.includes(id)) {
          icompSelectedSurgeons = icompSelectedSurgeons.filter(s => s !== id);
        } else if (icompSelectedSurgeons.length < 3) {
          icompSelectedSurgeons.push(id);
        }
        buildIcompSelector();
        renderInteractiveComparator();
      });
    });
  } else {
    const allUnits = ['Rodilla', 'Cadera', 'Hombro', 'Mano', 'Pie', 'Trauma'];
    const atMax = icompSelectedUnits.length >= 3;
    const count = icompSelectedUnits.length;

    let html = `<span class="icomp-hint">Pulsa para seleccionar 2-3 unidades (${count}/3)</span>`;
    html += '<div class="icomp-pill-grid">';
    allUnits.forEach(u => {
      const isActive = icompSelectedUnits.includes(u);
      const idx = icompSelectedUnits.indexOf(u);
      const cls = isActive ? 'active' : (atMax ? 'disabled' : '');
      const bg = isActive ? `background:${colors[idx]};border-color:${colors[idx]};` : '';
      html += `<button class="icomp-surgeon-pill ${cls}" data-unit="${u}" style="${bg}">${u}</button>`;
    });
    html += '</div>';
    container.innerHTML = html;

    container.querySelectorAll('.icomp-surgeon-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        const unit = btn.dataset.unit;
        if (icompSelectedUnits.includes(unit)) {
          icompSelectedUnits = icompSelectedUnits.filter(u => u !== unit);
        } else if (icompSelectedUnits.length < 3) {
          icompSelectedUnits.push(unit);
        }
        buildIcompSelector();
        renderInteractiveComparator();
      });
    });
  }
}

function buildIcompMetrics() {
  const container = document.getElementById('icomp-metrics');
  if (!container) return;
  let html = '';
  ICOMP_METRICS.forEach(m => {
    const checked = icompSelectedMetrics.includes(m.key);
    html += `<label class="icomp-metric-label${checked ? ' checked' : ''}">`;
    html += `<input type="checkbox" data-key="${m.key}"${checked ? ' checked' : ''}>`;
    html += `${m.label}</label>`;
  });
  container.innerHTML = html;

  container.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => {
      const key = cb.dataset.key;
      if (cb.checked) {
        if (!icompSelectedMetrics.includes(key)) icompSelectedMetrics.push(key);
      } else {
        icompSelectedMetrics = icompSelectedMetrics.filter(k => k !== key);
      }
      cb.parentElement.classList.toggle('checked', cb.checked);
      renderInteractiveComparator();
    });
  });
}

function buildIcompDeltaTable(metricLabels, datasets, container) {
  const n = datasets.length;
  const pairs = [];
  for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) pairs.push([i, j]);

  let html = '<table class="icomp-delta-table"><thead><tr><th>M\u00e9trica</th>';
  datasets.forEach(ds => { html += `<th>${ds.name}</th>`; });
  pairs.forEach(([i, j]) => {
    html += `<th>\u0394 ${datasets[i].name.substring(0, 4)}-${datasets[j].name.substring(0, 4)}</th>`;
  });
  html += '</tr></thead><tbody>';

  metricLabels.forEach((label, mi) => {
    html += `<tr><td>${label}</td>`;
    datasets.forEach(ds => { html += `<td>${ds.values[mi]}</td>`; });
    pairs.forEach(([i, j]) => {
      const diff = datasets[i].values[mi] - datasets[j].values[mi];
      const cls = diff > 0 ? 'td-delta-pos' : diff < 0 ? 'td-delta-neg' : 'td-delta-zero';
      const sign = diff > 0 ? '+' : '';
      html += `<td class="${cls}">${sign}${diff}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderInteractiveComparator() {
  const chartContainer = document.getElementById('icomp-chart');
  const deltaContainer = document.getElementById('icomp-delta');
  if (!chartContainer || !deltaContainer) return;
  chartContainer.innerHTML = '';
  deltaContainer.innerHTML = '';

  const theme = getChartTheme();
  const colors = theme.isDark ? ICOMP_COLORS_DARK : ICOMP_COLORS;
  const activeMetrics = ICOMP_METRICS.filter(m => icompSelectedMetrics.includes(m.key));

  if (activeMetrics.length === 0) {
    chartContainer.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);font-size:12px;">Selecciona al menos una m\u00e9trica</div>';
    return;
  }

  let datasets = [];
  if (icompMode === 'cirujano') {
    if (icompSelectedSurgeons.length < 2) {
      chartContainer.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);font-size:12px;">A\u00f1ade al menos 2 cirujanos para comparar</div>';
      return;
    }
    datasets = icompSelectedSurgeons.map((id, i) => {
      const entries = getIcompEntries(id);
      return { values: activeMetrics.map(m => entries.filter(m.fn).length), name: getSurnameOf(id), color: colors[i] };
    });
  } else {
    if (icompSelectedUnits.length < 2) {
      chartContainer.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);font-size:12px;">Selecciona al menos 2 unidades para comparar</div>';
      return;
    }
    datasets = icompSelectedUnits.map((unit, i) => {
      const ids = getSurgeonsByUnit(unit).filter(id => parsedData[id]);
      const allEntries = ids.flatMap(id => getIcompEntries(id));
      return { values: activeMetrics.map(m => allEntries.filter(m.fn).length), name: unit, color: colors[i] };
    });
  }

  const metricLabels = activeMetrics.map(m => m.label);

  if (icompViz === 'slope') {
    if (activeMetrics.length < 2) {
      chartContainer.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);font-size:12px;">Selecciona al menos 2 m\u00e9tricas para el slope chart</div>';
    } else {
      d3SlopeChart({ containerId: 'icomp-chart', labels: metricLabels, datasets, theme });
    }
  } else {
    d3GroupedHorizontalBar({ containerId: 'icomp-chart', metricLabels, datasets, theme });
  }

  buildIcompDeltaTable(metricLabels, datasets, deltaContainer);
}

function updateIcompPeriodLabels() {
  const btnMonth = document.getElementById('icomp-period-month');
  const btnTotal = document.getElementById('icomp-period-total');
  if (!btnMonth || !btnTotal) return;
  if (currentMonth !== null && currentYear !== null) {
    btnMonth.textContent = MONTH_NAMES[currentMonth].substring(0, 3) + ' ' + currentYear;
  } else {
    btnMonth.textContent = 'Mes';
  }
  if (availableMonths.length >= 2) {
    const first = availableMonths[0];
    const last = availableMonths[availableMonths.length - 1];
    const f = MONTH_NAMES[first.month].substring(0, 3);
    const l = MONTH_NAMES[last.month].substring(0, 3);
    if (first.year === last.year) {
      btnTotal.textContent = f + '–' + l + ' ' + last.year;
    } else {
      btnTotal.textContent = f + ' ' + first.year + '–' + l + ' ' + last.year;
    }
  } else {
    btnTotal.textContent = 'Total';
  }
}

function renderInteractiveComparatorInit(surgeonId) {
  if (icompMode === 'cirujano' && icompSelectedSurgeons.length === 0) {
    icompSelectedSurgeons = [surgeonId];
  }
  updateIcompPeriodLabels();
  buildIcompSelector();
  buildIcompMetrics();
  if ((icompMode === 'cirujano' && icompSelectedSurgeons.length >= 2) ||
      (icompMode === 'unidad' && icompSelectedUnits.length >= 2)) {
    renderInteractiveComparator();
  }
}

// ── Master render ──
function renderCharts(surgeonId) {
  destroyCharts();
  requestAnimationFrame(() => {
    renderBubblesChart(surgeonId);
    renderPercentilesCard(surgeonId);
    renderRadarChart(surgeonId);
    renderRadarTotalChart(surgeonId);
    renderUnitComparisonChart(surgeonId);
    renderComparadorChart(surgeonId);
    renderInteractiveComparatorInit(surgeonId);
    renderQxUnitChart(surgeonId);
    renderRankingGuardiasChart(surgeonId);
    renderRankingLocalizadosChart(surgeonId);
    renderRankingGestionChart(surgeonId);
    renderRankingTurnosChart(surgeonId);
    renderMorningAfternoonChart(surgeonId);
    renderFestivosChart(surgeonId);
  });
}

// Charts collapse/expand
document.getElementById('charts-header').addEventListener('click', () => {
  chartsExpanded = !chartsExpanded;
  const body = document.getElementById('charts-body');
  const btn = document.getElementById('charts-collapse-btn');
  if (chartsExpanded) {
    body.classList.add('expanded');
    btn.classList.add('rotated');
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid)) renderCharts(sid);
  } else {
    body.classList.remove('expanded');
    btn.classList.remove('rotated');
  }
});

// Comparativa toggle
document.querySelectorAll('#comparativa-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#comparativa-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    comparativaMode = this.dataset.mode;
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid) && chartsExpanded) {
      document.getElementById('chart-unit-comparison').innerHTML = '';
      renderUnitComparisonChart(sid);
    }
  });
});

// QX Unit toggle
document.querySelectorAll('#qx-unit-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#qx-unit-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    qxUnitMode = this.dataset.mode;
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid) && chartsExpanded) {
      document.getElementById('chart-qx-unit').innerHTML = '';
      renderQxUnitChart(sid);
    }
  });
});

// Comparador toggle
document.querySelectorAll('#comparador-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#comparador-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    comparadorMode = this.dataset.mode;
    const sid = parseInt(document.getElementById('surgeon-select').value, 10);
    if (!isNaN(sid) && chartsExpanded) renderComparadorChart(sid);
  });
});

// Interactive Comparator toggles
document.querySelectorAll('#icomp-mode-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#icomp-mode-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    icompMode = this.dataset.mode;
    icompSelectedSurgeons = [];
    icompSelectedUnits = [];
    buildIcompSelector();
    buildIcompMetrics();
    document.getElementById('icomp-chart').innerHTML = '';
    document.getElementById('icomp-delta').innerHTML = '';
  });
});
document.querySelectorAll('#icomp-period-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#icomp-period-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    icompPeriod = this.dataset.mode;
    renderInteractiveComparator();
  });
});
document.querySelectorAll('#icomp-viz-toggle button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('#icomp-viz-toggle button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    icompViz = this.dataset.viz;
    renderInteractiveComparator();
  });
});

// ─────────────────────────────────────────────
//  EXPORT: Menu logic
// ─────────────────────────────────────────────
function showExportMenu(type) {
  pendingExportType = type;
  const menu = document.getElementById('export-menu');
  const monthName = MONTH_NAMES[currentMonth];
  const label = type === 'ics' ? 'Calendario' : 'PDF';
  document.getElementById('export-opt-month').textContent = `${label}: Solo ${monthName}`;
  document.getElementById('export-opt-all').textContent = `${label}: Todos los meses`;
  menu.style.display = 'flex';
  // Highlight active button
  document.querySelector('.export-btn-ics').classList.toggle('active', type === 'ics');
  document.querySelector('.export-btn-pdf').classList.toggle('active', type === 'pdf');
}
function closeExportMenu() {
  document.getElementById('export-menu').style.display = 'none';
  pendingExportType = null;
  document.querySelector('.export-btn-ics').classList.remove('active');
  document.querySelector('.export-btn-pdf').classList.remove('active');
}
function doExport(scope) {
  const type = pendingExportType;
  closeExportMenu();
  if (type === 'ics') exportICS(scope);
  else if (type === 'pdf') exportPDF(scope);
}

// ─────────────────────────────────────────────
//  EXPORT: ICS (iCalendar)
// ─────────────────────────────────────────────
function exportICS(scope) {
  const sid = parseInt(document.getElementById('surgeon-select').value, 10);
  if (isNaN(sid) || !parsedData[sid]) return;

  const entries = scope === 'all'
    ? (parsedData[sid] || [])
    : getMonthEntries(sid);
  if (!entries.length) { mostrarToast('No hay datos para exportar'); return; }

  const surgeonName = SURGEONS[sid] || `T${sid}`;
  const surname = getSurnameOf(sid);
  const units = SURGEON_UNITS[sid];
  const unitStr = units ? units.join(', ') : '';

  function pad2(n) { return String(n).padStart(2, '0'); }
  function icsDate(y, m, d) { return `${y}${pad2(m + 1)}${pad2(d)}`; }
  function icsDateTime(y, m, d, h, min) { return `${y}${pad2(m + 1)}${pad2(d)}T${pad2(h)}${pad2(min)}00`; }
  function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }

  let ics = `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//COT Planning//ES\r\nCALSCALE:GREGORIAN\r\nX-WR-CALNAME:Planning ${surname}\r\n`;

  for (const e of entries) {
    const info = ACTIVITIES[e.activity];
    if (!info) continue;
    const title = info.tag;
    let desc = `Cirujano: ${surgeonName}`;
    if (unitStr) desc += `\\nUnidad: ${unitStr}`;
    if (e.companions && e.companions.length > 0) {
      const compNames = e.companions.map(cid => SURGEONS[cid] || `T${cid}`).join(', ');
      desc += `\\nCompa\u00f1ero: ${compNames}`;
    }

    ics += `BEGIN:VEVENT\r\n`;
    ics += `UID:${uid()}@cot-planning\r\n`;
    ics += `SUMMARY:${title}\r\n`;
    ics += `DESCRIPTION:${desc}\r\n`;
    ics += `LOCATION:Hospital San Juan de Dios del Aljarafe\r\n`;

    if (info.period === 'morning') {
      ics += `DTSTART:${icsDateTime(e.year, e.month, e.day, 8, 0)}\r\n`;
      ics += `DTEND:${icsDateTime(e.year, e.month, e.day, 15, 0)}\r\n`;
    } else if (info.period === 'afternoon') {
      ics += `DTSTART:${icsDateTime(e.year, e.month, e.day, 15, 30)}\r\n`;
      ics += `DTEND:${icsDateTime(e.year, e.month, e.day, 20, 30)}\r\n`;
    } else {
      ics += `DTSTART;VALUE=DATE:${icsDate(e.year, e.month, e.day)}\r\n`;
      ics += `DTEND;VALUE=DATE:${icsDate(e.year, e.month, e.day + 1)}\r\n`;
    }
    ics += `END:VEVENT\r\n`;
  }
  ics += `END:VCALENDAR\r\n`;

  const fileName = scope === 'all'
    ? `Planning_${surname}_Total.ics`
    : `Planning_${surname}_${MONTH_NAMES[currentMonth]}_${currentYear}.ics`;
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
  mostrarToast(`\u2713 Exportado ${entries.length} eventos`);
}

// ─────────────────────────────────────────────
//  EXPORT: PDF (html2canvas + jsPDF)
// ─────────────────────────────────────────────
const HSJD_LOGO = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAFcAWYDASIAAhEBAxEB/8QAHAABAAICAwEAAAAAAAAAAAAAAAEHBggCBAUD/8QASxAAAQMDAwIDBAYFCAgFBQAAAQACAwQFEQYSIQcxE0FRFCJhcQgVMoGRoRcjUrHBFiQzQlWSotEmNDU2U2Jy4UN0k/DxJWRzg6L/xAAbAQEAAgMBAQAAAAAAAAAAAAAABQYBAwQHAv/EADYRAAEEAgECBAQEBQQDAQAAAAEAAgMEBRExEiEGE0FRFCIygWFxkaEVFiM0sTNCUtEkNfDB/9oADAMBAAIRAxEAPwDctEREREREREREREREREREREREREREREUH5qR2UHv2UlEUdlKjPCZRYUooymUWVKBRlAsIpREWURERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERAieaIq+6s6zrdKPoxSsY/wAcHO4ZWBfpku/9nj/uhen9Jb+ktfycqZV0xGMrT1Wve3ZXnOezFutddHG7QCtP9Mt3/s8f90J+mW7/ANnj/uhVYikv4LT/AOChv5hv/wDNbDdL9eVuqLjJTVMTGtY3OQFZeFQX0eP9uVH/AE/wV+hUzLwMgsljBoL0TAWZLNRskh2SgRPNFGKbREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREUEnKIpRRlSiInmozynmiKlfpLf0lr+TlTKub6SuS+2fJypheh4H+yb915L4n/9i/7KURFMKvq1Po8f7cqP+n+Cv0Kgvo7/AO3ajP7B/cr8BXnue/u3L1fwv/YNU+aIoB9VDKxqUTKZREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREUFSociwVgGreplBp28y26ekkkfHjJB9V5P6aLV/YpR96rzraf9PKwfBv7lhBxgK50cLVmga947ledZLxHcr2XxsI0PwV9fpntP9il/Fcf01WnOPYJvxVDY4QY811/y/T9j+q4T4qyHuP0We9V9aUuq3UhpoXxeCDncsCRxz2UKVq1mVoxGzgKEu3JLcxkk5KlERdC5FmXTDVVNpe4SVFRG6QObgBqskdZ7UB/qUp+9UGQFyb5qKs4ivZkL5B3U5Sz1uowRRnsFfTetFpJ/1KX8UPWe0/2KX8VQnnwo88Ln/l+p7H9V1fzXf9x+i2T0j1KoNQ3mK2wUsjHyAkOJ4GAT/BZ8Oy1p6H/7+0fyf/hK2WHYBVXLVWVZ+hnCvGBvS3a3mScqURFFqcRERERERERERERERERERERERERERERERERERERERERERERERERERERERERQ5Sod2RCtZ+t4P8vaz5N/csHWcdbTnXdZz5N/csGPK9KxW/hGfkvGs2B8dJ+aDupGMIQAO6bfipBReiE+zhHclD80TvtZ9NIiIsr5QAk4UEFEWE7eqkcI3ug5PKOLQE9V9a7bWddEedfUfyf/AICtlh5fJa1dDv8Afyi+T/8AAVsq3sFQvEP939l6h4U/svupREUErQiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiKDnKIilcXeanJUFEVK9TNBXy9aqqa6jhDoXhu059AsX/RXqf+zD8VsiXMby5wHzK4+NB/xY/7wUzBmrMLAxvAVcs+HadiQyP5K1v/AEV6nz/qw/FB0r1PnmmH4rZESxE8SMP3rlxjhbf5ht/gtA8KUTwtTdWaWuem3Qi4xhnjZLV4SuX6Sg/WWv5OVMq2Yuy+zWbI/lUXNVGU7joY+ApREUiolezpbTlfqGpdDQsDnNGTlZI7pXqbyph+K9f6PA/+uz5/YP7lfeFUspmLFawWM4V7wmArXKgkk5K1s/RXqcD/AFYfig6V6nPemH4rZFz2N+05o+ZXxkraOM7X1ETT8XBcAz9w8KUPhagOSqg6YaEvdk1VT11ZAGwsDsn5tIVzjgYXyjqqaQbmTRuHwcF9Q4HkEEKKt2ZLL+uTlTlCpFUj6Iz2XIIuIz6qclcq71KIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIoPdMhD3Xh6y1DSadtEtbUOy4DDGebivpjDI4NbwtcsrYmF7uAuxf77bbJSGouFSyJoHAJ5P3KpNT9Y6hz3Q2elDWYI8R/f5hV1q3U1w1DcX1NXK7BPusHZoXh/PlXPH4CNjQ6bufZed5XxTNI8srnQ91kl21tqO5sMdTcZS0+QOF4/1pcf7bUf+oV00U9HVhYOlrQqxJdsSO6nPK9Ohv8Ad6Sds0FdOHt7EvJWaab6sX2ilaK93tcR+1u7gfBVwDgqOd3PZap8fBONOaFurZW1WcC15Vi9X9W27U8Nuko3EOYD4jHDlpVdnvwmOfVFsqVmVoxGzgLVduSXJTLJyUREXSuNWP0RutFarlU1NdOyGJrCSXH4LI9V9YthdDZIA/y8R/8ABUuHFrThxHrgriD6jKiJcRDPOZZO6noM7YrVxBGdfisivOtNRXYEVVfKW5yADjC8c3K4HvVzH5vK6qnA9V3x1YYx0taFFyXLEp255/VdyK63Bj2kVk4wcj3ysv0/1P1DbZWiWf2qIDGyTyWBpkjsvialBMNPatsGSs1ztjytmtE9QrTqFohkeKarzjw3nv8AEFZsDkdwtNKWpmp5hLE9zHtOQQcK++j2u33mJtqubx7WxuGP/bH+aqOVwprjzYu7f8K+4PxGLZEU3ZytDhSuPyXJV1W5ERERERERERERERERERERERERERERERERERERERERERERERERQe61+6/3maq1BHbmSfqYG5wD5nutgXd8LWrrbSPpdZTOcP6RoePvU3gGMda+ZVnxU97aR6fusEAyU2nGVAPmuW70V/K8sHSVChAMlc9rjwAcIXAcrLWl3ouLRz8EHdDkHamCE44RR5qURZC+dIiIiKAPNcgeCCoUFYWR8qkdlGMIOOFz2OxkNKE69Ua3rHHdcRg/NQp2nKD4IDtO/BCjB7L09OXGe1XenradxD4nhw574K80uJ8l2bXBLVV0UELC+R7g1rQOSVoshpicD7Lppktnb0+62+tkpnoYZnd3sBP4LtLp2djo7bTscMERgEfcu4vLnfUdL2yLfQNoiIvlbERERERERERERERERERERERERERFDkRSixzXc9/prUaiw+C6WPlzJGk7h8OVTc/VfVcEzopBSte04IMZ/wA131cfLaG41F3ctDSdqXa2HRUVYesddEXfWtIyfP2fDOzH71YemeolgvIazxxTzEcskPH4rNjF2YO7m9l81c1UsnTXd1mSLhHI2RocxwcD2IXIKPOwpUEHhSigKUWVBWB9WtHfyktgnpQ32yAEtGPtj0WeHuhC3QTvgeHs5C57VZlmIxvHYrTq52+rt07oaqCSKQHBDguptOe3dbdXjTlmuvNdQQyuxgOI5C8am6d6Ygm8T2Hfz9lx4Vqi8Ss6fnadqiz+DpOv+m8aVEaF0dcNRV7GNheynB9+UjAwr5tWgdP0NuFIKNkmRh7nDklZHRUVHQQiKlgjhjHYNGFzmqqaFhfLOxjQMklyhr2Wntv7dh7Kw43B1qMen6J91r31j0bT6erI6qgaW003l+yVXWclW5111NQ3F8NtopmzBh3Pc3tlVGSA7hW/EPlfVBk5VBz0cMdwiHhD3RDyUYOVKeqheSiL3bfZm1Ol6+5bX+JBJGG47YOc/uXhH7WFrjmbISB6LdNA+IAu9UQKW8HnsozytnotQHuvZ0bZn32/QW9n9c+8fgtlrHpCyWqhZTRUUT8N5c9oJJ9VrboW7myajpq7IDWuw4/ArZ206gtNxhjdS1sUhc0Hbu5Cp/iJ04kAbvpV+8JtrGJxfrqVYdW+nQLHXWyU+XDmWJvp5kKmKiCaCUxyxvY4dw4YK3JDo5RjLXA+WV5FbpbT9bK6aptdPJI7u4jlc9DPPrs6JR1BdmU8MR23+ZC7pWqFLTy1DvDhie95PZrcq5ejvT6WnlivV3hMb2kOhjd3+BKsu36XsFBL4tLbIIn/ALQC9hoDRtAwB5LGQzz7DOiMaBWcV4YZVeJJT1EKWjAwpUdgirytqlFGeUPIRFKLhI9sbC57g1o5JKw/U/UWw2Xczx/aJgOGRnj8VtihkmOmDa0T2Yq7eqR2lmaKh771luMzx9V0kdO0d/EO/P7l4svVHVErhtnhaT5NYf8ANSrMDacNkaUHJ4nptOmna2SRYb0vqb/XWk116e39Z/RtDSDj17rMfNRMsflvLd70p2vN50YfrW1KIi1rciIiIiIiIigqUKIuOMjlUJ1z0l9X1ovNGwiCZ2JABw0q/CvK1VbYrtYKullHuvjOfwW+tIY5mu9iuS7EJq72H1C1FwASCuOMdl9auMsqHtPkV8z2GF6iw9TQV4pI3TiNcLsW+uqqGqZPTSujew5BBWw/SrWcWora2GrkfoFa43CofV2mKKt09aewAv+rp5TtDQT+B8l0Q4/y3eVadKWjxJJY+k1X9Y3T7rFB8VHHopHxUKVChTx2XqaZuktovdJXxO2mKQE49Ox/JbXWevjuNogrYs7ZIw4ZWnq2F6DXo1+m5bfIXOkpXDk+h7D8iqt4jqgsbMPRXTwlec2V0B4I2qk6qymbW9xk9ZB/hAWLLM+slM+DXFc5zC1j3NLfiNoWGY4GfNTeOINZhHsq7lmuFyQH3Ud19KeN8szY2NLnOOAFwwc7W857K2+jOhJKmoZe7nARAw/qmvH2j64Wb1xlSIvcsYyhJdnEbB+ZVh9JdOCwaai8RuKioHiSH59vyWWVdTBSwumnkaxjRkknGFi+u9aW7S9IWue2SpLfciaefv9FQerda3bUExNTO9sWctjaeAqZWxtjISGV3YH1XoVvM1cTEIW9yBwrj1N1Ysduc+GiPtcrexactP3rBbh1e1FVzgUDYqcE4ADA796rEe87Lis66M2GO86oEkzQ6GmAe5p8/RTr8VUpQGR42R7qsx5u9kbDY2HpBPoru6ezX6ps7au+zh8kwDmNDA3aPuCyfyXFjQxu0AABcwqXK7reXAaXo0EZjjDXHahEIRaluUoUUd1lEWEdaqBlZoqpe4jMALws3XlaroY7jYKullHuvjOfwW+tIY5mu9iuS7EJq72H1C1FwASCuOMdl9auMsqHtPkV8z2GF6iw9TQV4pI3TiNcLsW+uqqGqZPTSujew5BBWw/SrWcWora2GrkfoFa43CofV2mKKt09aewAv+rp5TtDQT+B8l0Q4/y3eVadKWjxJJY+k1X9Y3T7rFB8VHHopHxUKVChTx2XqaZuktovdJXxO2mKQE49Ox/JbXWevjuNogrYs7ZIw4ZWnq2F6DXo1+m5bfIXOkpXDk+h7D8iqt4jqgsbMPRXTwlec2V0B4I2qk6qymbW9xk9ZB/hAWLLM+slM+DXFc5zC1j3NLfiNoWGY4GfNTeOINZhHsq7lmuFyQH3Ud19KeN8szY2NLnOOAFwwc7W857K2+jOhJKmoZe7nARAw/qmvH2j64Wb1xlSIvcsYyhJdnEbB+ZVh9JdOCwaai8RuKioHiSH59vyWWVdTBSwumnkaxjRkknGFi+u9aW7S9IWue2SpLfciaefv9FQerda3bUExNTO9sWctjaeAqZWxtjISGV3YH1XoVvM1cTEIW9yBwrj1N1Ysduc+GiPtcrexactP3rBbh1e1FVzgUDYqcE4ADA796rEe87Lis66M2GO86oEkzQ6GmAe5p8/RTr8VUpQGR42R7qsx5u9kbDY2HpBPoru6ezX6ps7au+zh8kwDmNDA3aPuCyfyXFjQxu0AABcwqXK7reXAaXo0EZjjDXHahEIRaluUoUUd1lEWEdaqBlZoqpe4jMALws3XlaroY7jYKullHuvjOfwW+tIY5mu9iuS7EJq72H1C1FwASCuOMdl9auMsqHtPkV8z2GF6iw9TQV4pI3TiNcLsW+uqqGqZPTSujew5BBWw/SrWcWora2GrkfoFa43CofV2mKKt09aewAv+rp5TtDQT+B8l0Q4/y3eVadKej/2Q==';

let pdfLibsLoaded = false;
function loadPdfLibs() {
  if (pdfLibsLoaded) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    s.onload = () => { pdfLibsLoaded = true; resolve(); };
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

const PDF_COLORS = {
  diferida: [100,116,139], qui_m: [26,58,92], cons_m: [22,163,74],
  saliente: [245,158,11], cons_t: [13,148,136], qui_t: [59,130,246],
  guardia: [220,38,38], localizado: [124,58,237], gestion: [202,138,4],
  diferida_t: [100,116,139], rucot: [225,29,72]
};

const fmtEur = n => n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' \u20ac';

// ─────────────────────────────────────────────
//  PDF: Landscape Single-Page Functions
// ─────────────────────────────────────────────

function pdfLandscapeHeader(pdf, surgeonName, monthName, year, units) {
  const pageW = 297;
  // Dark blue header block
  pdf.setFillColor(26, 58, 92);
  pdf.rect(0, 0, pageW, 14, 'F');
  pdf.setFillColor(35, 78, 122);
  pdf.rect(0, 14, pageW, 1.5, 'F');
  // Logo
  try { pdf.addImage(HSJD_LOGO, 'JPEG', 8, 2, 10, 10); } catch(e) {}
  // Hospital name
  pdf.setTextColor(255, 255, 255);
  pdf.setFont('helvetica', 'bold'); pdf.setFontSize(7);
  pdf.text('Hospital San Juan de Dios del Aljarafe', 21, 6);
  pdf.setFont('helvetica', 'normal'); pdf.setFontSize(5.5);
  pdf.text('Servicio de Cirug\u00eda Ortop\u00e9dica y Traumatolog\u00eda', 21, 10);
  // Title centered
  pdf.setFont('times', 'bold'); pdf.setFontSize(14);
  pdf.text(`Planning ${monthName} ${year}`, pageW / 2, 9, { align: 'center' });
  // Surgeon: name + unit on two lines, right-aligned
  const surname = surgeonName.split(' ').pop();
  pdf.setFont('helvetica', 'bold'); pdf.setFontSize(11);
  pdf.text(`Dr. ${surname}`, pageW - 10, 7.5, { align: 'right' });
  // Full name + unit pill on second line
  pdf.setFont('helvetica', 'normal'); pdf.setFontSize(6);
  pdf.setTextColor(200, 210, 225);
  let infoLine = surgeonName;
  if (units && units.length) infoLine += '  \u2014  ' + units.join(', ');
  pdf.text(infoLine, pageW - 10, 12, { align: 'right' });
}

function pdfLandscapeFooter(pdf) {
  const pageW = 297, pageH = 210;
  const y = pageH - 7;
  pdf.setDrawColor(26, 58, 92); pdf.setLineWidth(0.3);
  pdf.line(10, y, pageW - 10, y);
  pdf.setFontSize(6.5); pdf.setTextColor(120);
  pdf.setFont('helvetica', 'normal');
  pdf.text('COT \u2014 Planning Analyzer', 10, y + 3.5);
  pdf.setFontSize(6);
  pdf.text('P\u00e1gina 1 de 1', pageW / 2, y + 3.5, { align: 'center' });
  pdf.text(`Exportado: ${new Date().toLocaleDateString('es-ES')}`, pageW - 10, y + 3.5, { align: 'right' });
}

function pdfLandscapeCalendar(pdf, entries, mInfo, startY) {
  // Calendar: left panel, leaves room for guard card on the right
  const mx = 10, calW = 210, cellW = calW / 7, cellH = 30;
  const dayLabels = ['Lun', 'Mar', 'Mi\u00e9', 'Jue', 'Vie', 'S\u00e1b', 'Dom'];
  let y = startY;

  // Day headers
  pdf.setFillColor(26, 58, 92);
  pdf.rect(mx, y, calW, 7, 'F');
  pdf.setFont('helvetica', 'bold'); pdf.setFontSize(7.5);
  pdf.setTextColor(255, 255, 255);
  for (let i = 0; i < 7; i++) {
    pdf.text(dayLabels[i], mx + i * cellW + cellW / 2, y + 5, { align: 'center' });
  }
  y += 7;

  const firstDay = new Date(mInfo.year, mInfo.month, 1).getDay();
  const startCol = firstDay === 0 ? 6 : firstDay - 1;
  const daysInMonth = new Date(mInfo.year, mInfo.month + 1, 0).getDate();

  // Build day map with dedup
  const byDay = {};
  for (const e of entries) {
    if (!byDay[e.day]) byDay[e.day] = [];
    const existing = byDay[e.day].find(x => x.activity === e.activity);
    if (!existing) {
      byDay[e.day].push({ activity: e.activity, companions: e.companions ? [...e.companions] : [] });
    } else if (e.companions) {
      e.companions.forEach(c => { if (!existing.companions.includes(c)) existing.companions.push(c); });
    }
  }
  // Remove diferida when guardia exists on same day
  for (const day of Object.keys(byDay)) {
    const items = byDay[day];
    if (items.some(x => x.activity === 'guardia') && items.some(x => x.activity === 'diferida')) {
      byDay[day] = items.filter(x => x.activity !== 'diferida');
    }
  }

  let col = startCol, rowY = y;
  // Empty cells before day 1
  for (let c = 0; c < startCol; c++) {
    pdf.setFillColor(250, 250, 252); pdf.rect(mx + c * cellW, rowY, cellW, cellH, 'F');
    pdf.setDrawColor(225); pdf.rect(mx + c * cellW, rowY, cellW, cellH);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    if (col === 0 && d > 1) rowY += cellH;
    const x = mx + col * cellW;
    const isWknd = col >= 5;
    const isHol = isHoliday(mInfo.year, mInfo.month, d) || isInferredHoliday(mInfo.year, mInfo.month, d);
    if (isWknd || isHol) { pdf.setFillColor(252, 246, 246); pdf.rect(x, rowY, cellW, cellH, 'F'); }
    pdf.setDrawColor(225); pdf.rect(x, rowY, cellW, cellH);

    // Day number — top-left
    pdf.setFont('helvetica', 'bold'); pdf.setFontSize(8);
    pdf.setTextColor(isWknd || isHol ? 175 : 50);
    pdf.text(String(d), x + 1.5, rowY + 4);

    // Activity pills — full cell width, readable text + companion line below
    const dayItems = byDay[d] || [];
    const pillW = cellW - 2;
    let tagY = rowY + 6, tagCount = 0;
    for (const it of dayItems) {
      if (tagY + 4 > rowY + cellH - 1) break; // don't overflow cell
      const info = ACTIVITIES[it.activity]; if (!info) continue;
      const clr = PDF_COLORS[it.activity] || [100, 100, 100];
      const tagText = info.tag;

      // Draw activity pill
      pdf.setFillColor(clr[0], clr[1], clr[2]);
      pdf.roundedRect(x + 1, tagY, pillW, 4, 1, 1, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFont('helvetica', 'bold'); pdf.setFontSize(7);
      pdf.text(tagText, x + 1 + pillW / 2, tagY + 3, { align: 'center' });
      tagY += 4.2;

      // Companion line below the pill (smaller, muted)
      if ((it.activity === 'qui_m' || it.activity === 'qui_t') && it.companions && it.companions.length > 0) {
        const compName = it.companions.map(cid => { const full = SURGEONS[cid]; return full ? full.split(' ').pop() : `T${cid}`; }).join(', ');
        pdf.setFont('helvetica', 'italic'); pdf.setFontSize(5);
        pdf.setTextColor(clr[0], clr[1], clr[2]);
        pdf.text('\u2192 ' + compName, x + 1 + pillW / 2, tagY + 2, { align: 'center' });
        tagY += 3;
      } else {
        tagY += 0.5;
      }
      tagCount++;
    }
    col = (col + 1) % 7;
  }
  // Fill remaining cells
  if (col > 0) {
    for (let c = col; c < 7; c++) {
      pdf.setFillColor(250, 250, 252); pdf.rect(mx + c * cellW, rowY, cellW, cellH, 'F');
      pdf.setDrawColor(225); pdf.rect(mx + c * cellW, rowY, cellW, cellH);
    }
  }
  return rowY + cellH;
}

function pdfGuardSummaryCard(pdf, entries, mInfo, calStartY) {
  // Card sits to the right of the calendar, vertically centered
  const cX = 225, cW = 62;

  // Count guards and localizados
  let g17 = 0, g24 = 0, l17 = 0, l24 = 0;
  for (const e of entries.filter(e => e.activity === 'guardia')) {
    if (isNonWorkingDay(e.year, e.month, e.day)) g24++; else g17++;
  }
  for (const e of entries.filter(e => e.activity === 'localizado')) {
    if (isNonWorkingDay(e.year, e.month, e.day)) l24++; else l17++;
  }
  const gTotal = g17 + g24, lTotal = l17 + l24;

  if (gTotal === 0 && lTotal === 0) return;

  const R = RETRIB_RATES;
  const brutoG = g17 * R.gpf.r17 * R.gpf.h17 + g24 * R.gpf.r24 * R.gpf.h24;
  const brutoL = l17 * R.loc.m17 * R.loc.e17 + l24 * R.loc.m24 * R.loc.e24;
  const irpfFactor = (100 - DEFAULT_IRPF) / 100;
  const totalNeto = (brutoG + brutoL) * irpfFactor;

  // Calculate card height dynamically
  let rows = 0;
  if (gTotal > 0) rows++;
  if (lTotal > 0) rows++;
  const cH = 10 + rows * 14 + 16; // title + rows + neto box
  const cY = calStartY + 5; // just below calendar top

  // Card shadow + background
  pdf.setFillColor(240, 242, 245);
  pdf.roundedRect(cX + 0.5, cY + 0.5, cW, cH, 4, 4, 'F');
  pdf.setFillColor(255, 255, 255);
  pdf.roundedRect(cX, cY, cW, cH, 4, 4, 'F');
  pdf.setDrawColor(26, 58, 92); pdf.setLineWidth(0.6);
  pdf.roundedRect(cX, cY, cW, cH, 4, 4, 'S');

  // Title bar
  pdf.setFillColor(26, 58, 92);
  pdf.roundedRect(cX, cY, cW, 9, 4, 4, 'F');
  pdf.rect(cX, cY + 5, cW, 4, 'F');
  pdf.setFont('helvetica', 'bold'); pdf.setFontSize(8);
  pdf.setTextColor(255, 255, 255);
  pdf.text('Retribuci\u00f3n', cX + cW / 2, cY + 6.5, { align: 'center' });

  let iy = cY + 12;

  // Guard block
  if (gTotal > 0) {
    const gC = PDF_COLORS['guardia'];
    pdf.setFillColor(gC[0], gC[1], gC[2]);
    pdf.roundedRect(cX + 4, iy, cW - 8, 4, 1, 1, 'F');
    pdf.setFont('helvetica', 'bold'); pdf.setFontSize(7);
    pdf.setTextColor(255);
    pdf.text(`Guardias: ${gTotal}`, cX + cW / 2, iy + 3, { align: 'center' });
    iy += 5.5;
    pdf.setFont('helvetica', 'normal'); pdf.setFontSize(7);
    pdf.setTextColor(80);
    pdf.text(`${g17} laborable${g17 !== 1 ? 's' : ''}`, cX + 6, iy + 2.5);
    pdf.text(`${g24} festivo${g24 !== 1 ? 's' : ''}`, cX + cW / 2 + 2, iy + 2.5);
    iy += 6;
    pdf.setDrawColor(230); pdf.setLineWidth(0.2);
    pdf.line(cX + 6, iy, cX + cW - 6, iy);
    iy += 2;
  }

  // Localizado block
  if (lTotal > 0) {
    const lC = PDF_COLORS['localizado'];
    pdf.setFillColor(lC[0], lC[1], lC[2]);
    pdf.roundedRect(cX + 4, iy, cW - 8, 4, 1, 1, 'F');
    pdf.setFont('helvetica', 'bold'); pdf.setFontSize(7);
    pdf.setTextColor(255);
    pdf.text(`Localizados: ${lTotal}`, cX + cW / 2, iy + 3, { align: 'center' });
    iy += 5.5;
    pdf.setFont('helvetica', 'normal'); pdf.setFontSize(7);
    pdf.setTextColor(80);
    pdf.text(`${l17} laborable${l17 !== 1 ? 's' : ''}`, cX + 6, iy + 2.5);
    pdf.text(`${l24} festivo${l24 !== 1 ? 's' : ''}`, cX + cW / 2 + 2, iy + 2.5);
    iy += 6;
  }

  // Neto highlight — big and prominent
  iy += 1;
  pdf.setFillColor(220, 252, 231);
  pdf.roundedRect(cX + 3, iy, cW - 6, 10, 3, 3, 'F');
  pdf.setDrawColor(22, 163, 74); pdf.setLineWidth(0.4);
  pdf.roundedRect(cX + 3, iy, cW - 6, 10, 3, 3, 'S');
  pdf.setFont('helvetica', 'bold'); pdf.setFontSize(10);
  pdf.setTextColor(22, 163, 74);
  pdf.text(fmtEur(totalNeto), cX + cW / 2, iy + 5, { align: 'center' });
  pdf.setFont('helvetica', 'normal'); pdf.setFontSize(5.5);
  pdf.setTextColor(22, 140, 60);
  pdf.text('NETO', cX + cW / 2, iy + 8.5, { align: 'center' });
}

// ── Main Export: Landscape Single-Page PDF ──
async function exportPDF() {
  const sid = parseInt(document.getElementById('surgeon-select').value, 10);
  if (isNaN(sid)) return;

  mostrarToast('Generando PDF...');

  try { await loadPdfLibs(); } catch (e) {
    mostrarToast('Error cargando librerías PDF');
    return;
  }

  const surgeonName = SURGEONS[sid] || `T${sid}`;
  const surname = getSurnameOf(sid);
  const units = SURGEON_UNITS[sid];
  const mInfo = { month: currentMonth, year: currentYear };
  const monthName = MONTH_NAMES[mInfo.month] || '';
  const entries = (parsedData[sid] || []).filter(e => e.month === mInfo.month && e.year === mInfo.year);
  if (!entries.length) { mostrarToast('Sin datos para este cirujano'); return; }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  // Header (14mm)
  pdfLandscapeHeader(pdf, surgeonName, monthName, mInfo.year, units);

  // Calendar (left 210mm)
  const calEnd = pdfLandscapeCalendar(pdf, entries, mInfo, 17);

  // Guard summary card (right side, aligned with calendar top)
  pdfGuardSummaryCard(pdf, entries, mInfo, 17);

  // Footer
  pdfLandscapeFooter(pdf);

  const fileName = `Planning_${surname}_${monthName}_${mInfo.year}.pdf`;
  pdf.save(fileName);
  mostrarToast('\u2713 PDF exportado');
}
</script>
</body>
</html>
